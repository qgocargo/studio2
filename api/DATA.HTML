<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job File Management System with Database</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --theme-color: #4f46e5; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 1200px;
            margin: 1rem auto;
            padding: 1rem;
            background-color: white;
            border-radius: 0.75rem; /* Slightly larger radius */
            border-top: 5px solid var(--theme-color);
            box-shadow: 0 10px 25px rgba(0,0,0,0.05); /* Softer shadow */
        }
        @media (min-width: 640px) {
            .container {
                margin: 2rem auto;
                padding: 2.5rem; /* More padding on desktop */
            }
        }
        .input-field {
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
            width: 100%;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .input-field:focus {
            outline: none;
            border-color: var(--theme-color);
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.3); /* Improved focus ring */
        }
        .input-field:disabled {
            background-color: #f3f4f6;
            cursor: not-allowed;
            color: #6b7280;
        }
        .table-cell {
            border: 1px solid #e5e7eb; /* Lighter border */
            padding: 0.5rem;
            position: relative;
        }
        @media (min-width: 640px) {
            .table-cell {
                padding: 0.75rem;
            }
        }
        .table-cell input {
            width: 100%;
            border: none;
            padding: 0;
            background-color: transparent;
        }
        .table-cell input:focus {
            outline: none;
        }
        
        .overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.5); display: flex;
            align-items: center; justify-content: center; z-index: 1000;
            opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s;
            padding: 1rem;
        }
        .overlay.visible {
            opacity: 1; visibility: visible;
        }
        .modal-content {
            background: white; padding: 1.5rem; border-radius: 0.5rem;
            width: 100%;
            max-width: 600px;
            max-height: 90vh; overflow-y: auto;
            transform: scale(0.9); transition: transform 0.3s;
        }
        .overlay.visible .modal-content {
            transform: scale(1);
        }
        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid var(--theme-color);
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #notification {
            position: fixed; bottom: 20px; left: 50%;
            transform: translateX(-50%);
            background-color: #2d3748; color: white;
            padding: 1rem 1.5rem; border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translate(-50%, 100px); opacity: 0;
            transition: transform 0.5s, opacity 0.5s;
            z-index: 2000;
            text-align: center;
        }
        #notification.show {
            transform: translate(-50%, 0); opacity: 1;
        }

        @page { size: A4; margin: 0.5cm; }
        @media print {
            body { background-color: white !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            #main-container, .no-print, #app-container, #login-screen { display: none !important; }
            #print-output, #public-view-container, #analytics-container { display: block !important; padding: 0 !important; margin: 0 !important; }
        }
        #print-output .print-table, #preview-modal .print-table, #analytics-container .analytics-table { border-collapse: collapse; width: 100%; }
        #print-output .print-table th, #print-output .print-table td,
        #preview-modal .print-table th, #preview-modal .print-table td,
        #analytics-container .analytics-table th, #analytics-container .analytics-table td { border: 1px solid #d1d5db; padding: 0.5rem; text-align: left; }
        #analytics-container .analytics-table th { background-color: #f3f4f6; font-weight: 600; }
        #print-output .print-field, #preview-modal .print-field { border: 1px solid #6b7280; padding: 0.3rem; min-height: 24px; word-break: break-all; }
        .admin-only, .checker-only, #signup-name-field { display: none; }
        
        .stamp {
            position: absolute;
            top: -10px; right: -10px;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: bold;
            text-transform: uppercase;
            transform: rotate(15deg);
            opacity: 0.8;
            display: none;
        }
        .stamp-approved { border: 2px solid #16a34a; color: #16a34a; }
        .stamp-checked { border: 2px solid #2563eb; color: #2563eb; }
        .stamp-rejected { border: 2px solid #dc2626; color: #dc2626; }

        /* Autocomplete styles */
        .autocomplete-suggestions {
            border: 1px solid #d1d5db;
            border-top: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            max-height: 150px;
            overflow-y: auto;
            position: absolute;
            background-color: white;
            z-index: 999;
            width: 100%;
        }
        .autocomplete-suggestion {
            padding: 0.5rem;
            cursor: pointer;
        }
        .autocomplete-suggestion:hover {
            background-color: #f3f4f6;
        }
        .autocomplete-suggestion.selected {
            background-color: #e5e7eb;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
        <div class="max-w-md w-full space-y-8">
            <div>
                <img class="mx-auto h-24 w-auto" src="http://qgocargo.com/logo.png" alt="Q'go Cargo Logo">
                <h2 id="auth-title" class="mt-6 text-center text-3xl font-extrabold text-gray-900">Sign in to your account</h2>
            </div>
            <div class="mt-8 space-y-6 bg-white p-8 rounded-lg shadow-md">
                <div id="approval-message" class="hidden p-4 text-center text-yellow-800 bg-yellow-100 rounded-lg">
                    Your account is awaiting admin approval.
                </div>
                 <div id="blocked-message" class="hidden p-4 text-center text-red-800 bg-red-100 rounded-lg">
                    Your account has been blocked by an administrator.
                </div>
                <div class="rounded-md shadow-sm -space-y-px">
                    <div id="signup-name-field">
                        <label for="full-name" class="sr-only">Full Name</label>
                        <input id="full-name" name="name" type="text" autocomplete="name" required class="input-field rounded-t-md" placeholder="Full Name">
                    </div>
                    <div>
                        <label for="email-address" class="sr-only">Email address</label>
                        <input id="email-address" name="email" type="email" autocomplete="email" required class="input-field" placeholder="Email address">
                    </div>
                    <div>
                        <label for="password" class="sr-only">Password</label>
                        <input id="password" name="password" type="password" autocomplete="current-password" required class="input-field rounded-b-md" placeholder="Password">
                    </div>
                </div>
                <div>
                    <button id="auth-btn" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Sign in
                    </button>
                </div>
                <p class="mt-2 text-center text-sm text-gray-600">
                    <a href="#" id="auth-link" class="font-medium text-indigo-600 hover:text-indigo-500">
                        Create a new account
                    </a>
                </p>
                <div class="text-center mt-2 text-sm">
                    <a href="#" id="forgot-password-link" class="font-medium text-indigo-600 hover:text-indigo-500">
                        Forgot your password?
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Application Container (Hidden by default) -->
    <div id="app-container" class="hidden">
        <div id="main-container" class="container">
            <!-- Header Section -->
            <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                <div class="flex items-center">
                    <img id="logo-container" class="h-16 w-auto mr-4" src="http://qgocargo.com/logo.png" alt="Q'go Cargo Logo">
                    <h1 class="text-3xl sm:text-4xl font-bold text-gray-800 border-l-4 border-gray-300 pl-4">JOB FILE</h1>
                </div>
                <div class="text-right w-full sm:w-auto">
                    <div class="flex items-center mb-2">
                        <label for="date" class="mr-2 font-semibold text-gray-700">Date:</label>
                        <input type="date" id="date" class="input-field w-full sm:w-40">
                    </div>
                    <div class="flex items-center">
                        <label for="po-number" class="mr-2 font-semibold text-gray-700">P.O. #:</label>
                        <input type="text" id="po-number" class="input-field w-full sm:w-40">
                    </div>
                </div>
            </header>
            
            <!-- User Info and Logout -->
            <div class="flex flex-col sm:flex-row justify-between items-center mb-4 bg-gray-50 p-2 rounded-md gap-2">
                <div class="text-sm text-center sm:text-left">
                    Logged in as: <span id="user-display-name" class="font-bold"></span> (<span id="user-role" class="capitalize"></span>)
                </div>
                 <div class="flex-grow text-center">
                     <button onclick="openAnalyticsDashboard()" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-5 rounded-md text-base">Analytics</button>
                 </div>
                <div>
                    <button id="activity-log-btn" class="admin-only bg-gray-500 hover:bg-gray-600 text-white font-bold py-1 px-3 rounded text-sm mr-2">Activity Log</button>
                    <button id="admin-panel-btn" class="admin-only bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-1 px-3 rounded text-sm mr-2">Admin Panel</button>
                    <button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded text-sm">Logout</button>
                </div>
            </div>
            
            <!-- Status Summary -->
            <div id="status-summary-main" class="mb-4"></div>

            <div id="checker-info-banner" class="checker-only hidden p-3 mb-4 text-center text-blue-800 bg-blue-100 rounded-lg">
                <strong>Note:</strong> Files must be checked before they can be approved or rejected by an admin.
            </div>

            <div id="rejection-banner" class="hidden p-3 mb-4 text-center text-red-800 bg-red-100 rounded-lg">
                <strong>This job file was rejected.</strong> Reason: <span id="rejection-reason"></span>
            </div>

            <!-- Form Fields -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                <div class="lg:col-span-2">
                    <label for="job-file-no" class="block mb-1 font-semibold text-gray-700">Job File No.:</label>
                    <input type="text" id="job-file-no" class="input-field" placeholder="Enter a unique ID here...">
                </div>
                <div class="flex items-end space-x-8 pb-1">
                    <div>
                        <span class="font-semibold text-gray-700">Clearance</span>
                        <div class="mt-2 space-y-1">
                            <label class="flex items-center"><input type="checkbox" class="mr-2" data-clearance="Export"> Export</label>
                            <label class="flex items-center"><input type="checkbox" class="mr-2" data-clearance="Import"> Import</label>
                            <label class="flex items-center"><input type="checkbox" class="mr-2" data-clearance="Clearance"> Clearance</label>
                            <label class="flex items-center"><input type="checkbox" class="mr-2" data-clearance="Local Move"> Local Move</label>
                        </div>
                    </div>
                    <div>
                        <span class="font-semibold text-gray-700">Product Type</span>
                        <div class="mt-2 space-y-1">
                            <label class="flex items-center"><input type="checkbox" class="mr-2" data-product="Air Freight"> Air Freight</label>
                            <label class="flex items-center"><input type="checkbox" class="mr-2" data-product="Sea Freight"> Sea Freight</label>
                            <label class="flex items-center"><input type="checkbox" class="mr-2" data-product="Land Freight"> Land Freight</label>
                            <label class="flex items-center"><input type="checkbox" class="mr-2" data-product="Others"> Others</label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div><label for="invoice-no" class="block mb-1 font-semibold text-gray-700">Invoice No.:</label><input type="text" id="invoice-no" class="input-field"></div>
                <div><label for="billing-date" class="block mb-1 font-semibold text-gray-700">Billing Date:</label><input type="date" id="billing-date" class="input-field"></div>
                <div><label for="salesman" class="block mb-1 font-semibold text-gray-700">Salesman:</label><input type="text" id="salesman" class="input-field"></div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="relative">
                    <label for="shipper-name" class="block mb-1 font-semibold text-gray-700">Shipper's Name:</label>
                    <input type="text" id="shipper-name" class="input-field" autocomplete="off">
                    <div id="shipper-suggestions" class="autocomplete-suggestions hidden"></div>
                </div>
                <div class="relative">
                    <label for="consignee-name" class="block mb-1 font-semibold text-gray-700">Consignee's Name:</label>
                    <input type="text" id="consignee-name" class="input-field" autocomplete="off">
                    <div id="consignee-suggestions" class="autocomplete-suggestions hidden"></div>
                </div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                <div><label for="mawb" class="block mb-1 font-semibold text-gray-700">MAWB / OBL / TCN No.:</label><input type="text" id="mawb" class="input-field"></div>
                <div><label for="hawb" class="block mb-1 font-semibold text-gray-700">HAWB / HBL:</label><input type="text" id="hawb" class="input-field"></div>
                <div><label for="teams-of-shipping" class="block mb-1 font-semibold text-gray-700">Teams of Shipping:</label><input type="text" id="teams-of-shipping" class="input-field"></div>
                <div><label for="origin" class="block mb-1 font-semibold text-gray-700">Origin:</label><input type="text" id="origin" class="input-field"></div>
                <div><label for="no-of-pieces" class="block mb-1 font-semibold text-gray-700">No. of Pieces:</label><input type="text" id="no-of-pieces" class="input-field"></div>
                <div><label for="gross-weight" class="block mb-1 font-semibold text-gray-700">Gross Weight:</label><input type="text" id="gross-weight" class="input-field"></div>
                <div><label for="destination" class="block mb-1 font-semibold text-gray-700">Destination:</label><input type="text" id="destination" class="input-field"></div>
                <div><label for="volume-weight" class="block mb-1 font-semibold text-gray-700">Volume Weight:</label><input type="text" id="volume-weight" class="input-field"></div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="sm:col-span-2">
                    <label for="description" class="block mb-1 font-semibold text-gray-700">Description:</label>
                    <input type="text" id="description" class="input-field">
                </div>
                <div><label for="carrier" class="block mb-1 font-semibold text-gray-700">Carrier / Shipping Line / Trucking Co:</label><input type="text" id="carrier" class="input-field"></div>
                <div><label for="truck-no" class="block mb-1 font-semibold text-gray-700">Truck No. / Driver's Name:</label><input type="text" id="truck-no" class="input-field"></div>
                <div><label for="vessel-name" class="block mb-1 font-semibold text-gray-700">Vessel's Name:</label><input type="text" id="vessel-name" class="input-field"></div>
                <div><label for="flight-voyage-no" class="block mb-1 font-semibold text-gray-700">Flight / Voyage No.:</label><input type="text" id="flight-voyage-no" class="input-field"></div>
                <div><label for="container-no" class="block mb-1 font-semibold text-gray-700">Container No.:</label><input type="text" id="container-no" class="input-field"></div>
            </div>

            <!-- Charges Table -->
            <div class="flex justify-between items-center mb-2">
                 <h2 class="text-xl font-semibold text-gray-800">Charges</h2>
                 <div>
                     <button onclick="openChargeManager()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-1 px-3 rounded-lg text-sm transition-transform transform hover:scale-105 mr-2">Manage Descriptions</button>
                     <button onclick="suggestCharges()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-1 px-3 rounded-lg text-sm transition-transform transform hover:scale-105">Suggest Charges ‚ú®</button>
                 </div>
            </div>
            <div class="mb-6 overflow-x-auto border border-gray-200 rounded-lg">
                <table id="charges-table" class="w-full border-collapse">
                    <!-- JS will populate this -->
                </table>
            </div>
            <div class="text-right mb-6">
                 <button onclick="addChargeRow()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg text-sm">+ Add Charge</button>
            </div>

            <!-- Remarks Section -->
            <div class="flex justify-between items-center mb-2">
                <label for="remarks" class="block font-semibold text-gray-700">REMARKS:</label>
                <button onclick="generateRemarks()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-1 px-3 rounded-lg text-sm transition-transform transform hover:scale-105">Generate Remarks ‚ú®</button>
            </div>
            <div class="mb-8">
                <textarea id="remarks" rows="4" class="input-field w-full"></textarea>
            </div>

            <!-- Creator/Editor Info -->
            <div id="file-info" class="text-xs text-gray-500 mb-4 border-t pt-4">
                <span id="created-by-info"></span>
                <span id="last-updated-by-info" class="ml-4"></span>
            </div>

            <!-- Footer Section -->
            <footer class="grid grid-cols-1 md:grid-cols-3 gap-8 pt-6 border-t items-end">
                <div><label class="block mb-2 font-semibold text-gray-700">PREPARED BY</label><input type="text" id="prepared-by" class="input-field bg-gray-100" readonly></div>
                <div class="relative">
                    <div id="checked-stamp" class="stamp stamp-checked">Checked</div>
                    <label class="block mb-2 font-semibold text-gray-700">CHECKED BY</label>
                    <input type="text" id="checked-by" class="input-field bg-gray-100" readonly>
                    <button id="check-btn" class="checker-only mt-2 w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">Check Job File</button>
                </div>
                <div class="relative">
                    <div id="approved-stamp" class="stamp stamp-approved">Approved</div>
                    <div id="rejected-stamp" class="stamp stamp-rejected">Rejected</div>
                    <label class="block mb-2 font-semibold text-gray-700">APPROVED BY</label>
                    <input type="text" id="approved-by" class="input-field bg-gray-100" readonly>
                    <div id="approval-buttons" class="admin-only mt-2 w-full flex gap-2">
                        <button id="approve-btn" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded">Approve</button>
                        <button id="reject-btn" class="flex-1 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded">Reject</button>
                    </div>
                </div>
            </footer>

            <!-- Action Buttons -->
            <div class="text-center mt-10 no-print flex flex-wrap justify-center gap-2 sm:gap-4">
                 <button onclick="openClientManager()" class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-transform transform hover:scale-105 flex items-center space-x-2">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z" /></svg>
                     <span>Clients</span>
                 </button>
                 <button onclick="openFileManager()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-transform transform hover:scale-105 flex items-center space-x-2">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4l2 2h4a2 2 0 012 2v1H8a3 3 0 00-3 3v1.586l.293.293a1 1 0 001.414 0L10.414 12l-1.293 1.293a1 1 0 000 1.414l.293.293V16a2 2 0 01-2 2H4a2 2 0 01-2-2V6zm8 2a1 1 0 000-2H4a1 1 0 00-1 1v10a1 1 0 001 1h4a1 1 0 001-1v-1.586l-.293-.293a1 1 0 01-1.414 0L6.586 12l1.293-1.293a1 1 0 011.414 0l.293-.293V8z" clip-rule="evenodd" /><path d="M18 8a2 2 0 00-2-2h-4l-2-2h-4a2 2 0 00-2 2v.5a1 1 0 002 0V6a1 1 0 011-1h2.586l2 2H16a1 1 0 011 1v8a1 1 0 01-1 1h-2.5a1 1 0 100 2H16a2 2 0 002-2V8z" /></svg>
                     <span>File Manager</span>
                 </button>
                 <button onclick="saveJobFile()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-transform transform hover:scale-105 flex items-center space-x-2">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M7.707 10.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6a1 1 0 10-2 0v5.586L7.707 10.293zM3 4a1 1 0 011-1h12a1 1 0 011 1v4a1 1 0 01-1 1h-2a1 1 0 00-1 1v4a1 1 0 001 1h2a1 1 0 011 1v4a1 1 0 01-1 1H4a1 1 0 01-1-1v-4a1 1 0 011-1h2a1 1 0 001-1V9a1 1 0 00-1-1H4a1 1 0 01-1-1V4z" /></svg>
                     <span>Save to DB</span>
                 </button>
                 <button onclick="clearForm()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-transform transform hover:scale-105 flex items-center space-x-2">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.898 0V3a1 1 0 112 0v2.101a7.002 7.002 0 01-11.898 0V3a1 1 0 01-1-1zM12 10a2 2 0 11-4 0 2 2 0 014 0zM4 10a2 2 0 00-2 2v2a2 2 0 002 2h12a2 2 0 002-2v-2a2 2 0 00-2-2h-1.101A7.002 7.002 0 0010 12c-2.256 0-4.233-.996-5.5-2.543A7.002 7.002 0 004 10z" clip-rule="evenodd" /></svg>
                     <span>New Job</span>
                 </button>
                 <button onclick="printPage()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-transform transform hover:scale-105 flex items-center space-x-2">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v6a2 2 0 002 2h12a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v4h6v-4z" clip-rule="evenodd" /></svg>
                     <span>Print</span>
                 </button>
            </div>
        </div>
    </div>

    <!-- This container is hidden by default and will be populated for printing/preview -->
    <div id="print-output" class="hidden"></div>
    
    <!-- This container is for the public QR code view -->
    <div id="public-view-container"></div>

    <!-- Analytics Full-Screen Page -->
    <div id="analytics-container" class="hidden">
        <div class="container">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-2 no-print">
                <h3 class="text-2xl font-bold">Analytics Dashboard</h3>
                <div>
                    <button onclick="printAnalytics()" title="Print Analytics" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-3 rounded mr-4">üñ®Ô∏è Print</button>
                    <button onclick="closeAnalyticsDashboard()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-3 rounded">Back to Job File</button>
                </div>
            </div>
            <div id="analytics-body" class="space-y-6"></div>
        </div>
    </div>


    <!-- Modals -->
    <div id="loader-overlay" class="overlay"><div class="loader"></div></div>
    <div id="notification"></div>
    
    <!-- File Manager Modal -->
    <div id="file-manager-modal" class="overlay">
        <div class="modal-content max-w-5xl"> <!-- Increased width for filters -->
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold">File Manager</h3>
                <div>
                    <button onclick="openRecycleBin()" class="admin-only bg-gray-600 hover:bg-gray-700 text-white font-bold py-1 px-3 rounded text-sm mr-4">Recycle Bin</button>
                    <button onclick="closeModal('file-manager-modal')" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
                </div>
            </div>
            
            <!-- Search and Filter Controls -->
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-4 p-4 bg-gray-50 rounded-lg">
                <div class="md:col-span-2">
                    <label for="search-bar" class="text-sm font-medium text-gray-700">Search</label>
                    <input type="text" id="search-bar" class="input-field mt-1" placeholder="Job No, Shipper, etc.">
                </div>
                <div>
                    <label for="filter-status" class="text-sm font-medium text-gray-700">Status</label>
                    <select id="filter-status" class="input-field mt-1">
                        <option value="">All Statuses</option>
                        <option value="pending">Pending</option>
                        <option value="checked">Checked</option>
                        <option value="approved">Approved</option>
                        <option value="rejected">Rejected</option>
                    </select>
                </div>
                <div>
                    <label for="filter-date-from" class="text-sm font-medium text-gray-700">From Date</label>
                    <input type="date" id="filter-date-from" class="input-field mt-1">
                </div>
                <div>
                    <label for="filter-date-to" class="text-sm font-medium text-gray-700">To Date</label>
                    <input type="date" id="filter-date-to" class="input-field mt-1">
                </div>
                <div class="flex items-end">
                    <button id="clear-filters-btn" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded text-sm">Clear Filters</button>
                </div>
            </div>

            <div id="job-files-list" class="space-y-2 max-h-[60vh] overflow-y-auto"></div>
        </div>
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="overlay">
        <div class="modal-content max-w-sm">
            <h3 class="text-lg font-bold mb-4" id="confirm-title">Confirm Action</h3>
            <div id="confirm-message" class="mb-4 text-sm">Are you sure?</div>
            <div class="text-right mt-6 space-x-2">
                <button id="confirm-cancel" class="bg-gray-300 hover:bg-gray-400 text-black font-bold py-2 px-4 rounded">Cancel</button>
                <button id="confirm-ok" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Preview Modal -->
    <div id="preview-modal" class="overlay">
        <div class="modal-content max-w-4xl">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-4 no-print gap-2">
                <h3 class="text-2xl font-bold">Job File Preview</h3>
                <div>
                    <button onclick="printPreview()" title="Print Preview" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-3 rounded mr-4">üñ®Ô∏è Print</button>
                    <button onclick="closeModal('preview-modal')" class="text-gray-500 hover:text-gray-800 text-3xl align-middle">&times;</button>
                </div>
            </div>
            <div id="preview-body"></div>
        </div>
    </div>

    <!-- Admin Panel Modal -->
    <div id="admin-panel-modal" class="overlay">
        <div class="modal-content max-w-2xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold">Admin Panel</h3>
                <button onclick="closeModal('admin-panel-modal')" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>
        
            <!-- User Management -->
            <div class="border rounded-lg p-4">
                <h4 class="text-lg font-semibold mb-2">User Management</h4>
                <div id="user-list" class="space-y-2 max-h-[40vh] overflow-y-auto"></div>
                <div class="text-right mt-4">
                    <button onclick="saveUserChanges()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Save User Changes</button>
                </div>
            </div>
        
            <!-- Data Backup & Restore -->
            <div class="border rounded-lg p-4 mt-6">
                <h4 class="text-lg font-semibold mb-3">Data Backup & Restore</h4>
                <p class="text-sm text-gray-600 mb-4">Backup all job files and user data to a single JSON file. This can be used for offline storage or to restore the database to a previous state.</p>
                <div class="flex flex-col sm:flex-row gap-4">
                    <button onclick="backupAllData()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                        Backup All Data
                    </button>
                    <label for="restore-file-input" class="flex-1 bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded flex items-center justify-center gap-2 cursor-pointer">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                         Restore From File
                         <input type="file" id="restore-file-input" class="hidden" accept=".json" onchange="handleRestoreFile(event)">
                    </label>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Rejection Reason Modal -->
    <div id="reject-reason-modal" class="overlay">
        <div class="modal-content max-w-md">
            <h3 class="text-lg font-bold mb-4">Rejection Reason</h3>
            <p class="mb-4">Please provide a reason for rejecting this job file.</p>
            <textarea id="rejection-reason-input" class="input-field w-full" rows="3"></textarea>
            <div class="text-right mt-6 space-x-2">
                <button onclick="closeModal('reject-reason-modal')" class="bg-gray-300 hover:bg-gray-400 text-black font-bold py-2 px-4 rounded">Cancel</button>
                <button id="confirm-reject-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">Confirm Rejection</button>
            </div>
        </div>
    </div>

    <!-- Forgot Password Modal -->
    <div id="forgot-password-modal" class="overlay">
        <div class="modal-content max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Reset Password</h3>
                <button onclick="closeModal('forgot-password-modal')" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>
            <p class="mb-4 text-gray-600">Enter your email address and we will send you a link to reset your password.</p>
            <div>
                <label for="reset-email" class="sr-only">Email address</label>
                <input id="reset-email" name="email" type="email" autocomplete="email" required class="input-field" placeholder="Email address">
            </div>
            <div class="text-right mt-6">
                <button id="send-reset-link-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded">
                    Send Password Reset Link
                </button>
            </div>
        </div>
    </div>

    <!-- Client Manager Modal -->
    <div id="client-manager-modal" class="overlay">
        <div class="modal-content max-w-4xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold">Client Management</h3>
                <button onclick="closeModal('client-manager-modal')" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Add/Edit Client Form -->
                <div>
                    <h4 id="client-form-title" class="text-xl font-semibold mb-4">Add New Client</h4>
                    <form id="client-form" class="space-y-4">
                        <input type="hidden" id="client-id">
                        <div>
                            <label for="client-name" class="block text-sm font-medium text-gray-700">Client Name</label>
                            <input type="text" id="client-name" class="input-field mt-1" required>
                        </div>
                        <div>
                            <label for="client-address" class="block text-sm font-medium text-gray-700">Address</label>
                            <textarea id="client-address" rows="2" class="input-field mt-1"></textarea>
                        </div>
                        <div>
                            <label for="client-contact-person" class="block text-sm font-medium text-gray-700">Contact Person</label>
                            <input type="text" id="client-contact-person" class="input-field mt-1">
                        </div>
                        <div>
                            <label for="client-phone" class="block text-sm font-medium text-gray-700">Phone</label>
                            <input type="text" id="client-phone" class="input-field mt-1">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Client Type</label>
                            <select id="client-type" class="input-field mt-1">
                                <option value="Shipper">Shipper</option>
                                <option value="Consignee">Consignee</option>
                                <option value="Both">Both</option>
                            </select>
                        </div>
                        <div class="flex gap-4">
                            <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Save Client</button>
                            <button type="button" id="clear-client-form-btn" class="w-full bg-gray-300 hover:bg-gray-400 text-black font-bold py-2 px-4 rounded">Clear</button>
                        </div>
                    </form>
                </div>
                <!-- Client List -->
                <div>
                    <h4 class="text-xl font-semibold mb-4">Existing Clients</h4>
                    <input type="text" id="client-search-bar" class="input-field mb-4" placeholder="Search clients...">
                    <div id="client-list" class="space-y-2 max-h-[50vh] overflow-y-auto">
                        <!-- Client list will be populated by JS -->
                    </div>
                </div>
            </div>
        </div>
    </div>

     <!-- Charge Manager Modal -->
    <div id="charge-manager-modal" class="overlay">
        <div class="modal-content max-w-lg">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold">Manage Charge Descriptions</h3>
                <button onclick="closeModal('charge-manager-modal')" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>
            <div class="space-y-4">
                <div>
                    <h4 class="text-lg font-semibold mb-2">Add New Description</h4>
                    <div class="flex gap-2">
                        <input type="text" id="new-charge-description" class="input-field" placeholder="E.g., Customs Duty">
                        <button onclick="saveChargeDescription()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Add</button>
                    </div>
                </div>
                <div>
                    <h4 class="text-lg font-semibold mb-2">Existing Descriptions</h4>
                    <div id="charge-description-list" class="space-y-2 max-h-[50vh] overflow-y-auto">
                        <!-- JS will populate this list -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Activity Log Modal -->
    <div id="activity-log-modal" class="overlay">
        <div class="modal-content max-w-4xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold">User Activity Log</h3>
                <button onclick="closeModal('activity-log-modal')" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>
            <div class="max-h-[70vh] overflow-y-auto">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="table-cell font-semibold text-left">User Name</th>
                            <th class="table-cell font-semibold text-left">Job File No.</th>
                            <th class="table-cell font-semibold text-left">Time Opened</th>
                        </tr>
                    </thead>
                    <tbody id="activity-log-body">
                        <!-- JS will populate this -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- User-Specific Jobs Modal -->
    <div id="user-jobs-modal" class="overlay">
        <div class="modal-content max-w-5xl">
            <div class="flex justify-between items-center mb-4">
                <h3 id="user-jobs-modal-title" class="text-2xl font-bold">User's Job Files</h3>
                <button onclick="closeModal('user-jobs-modal')" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>
            <div id="user-jobs-list" class="space-y-2 max-h-[70vh] overflow-y-auto">
                <!-- JS will populate this list -->
            </div>
        </div>
    </div>

    <!-- Recycle Bin Modal -->
    <div id="recycle-bin-modal" class="overlay">
        <div class="modal-content max-w-5xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold">Recycle Bin</h3>
                <button onclick="closeModal('recycle-bin-modal')" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>
            <div id="recycle-bin-list" class="space-y-2 max-h-[70vh] overflow-y-auto">
                <!-- JS will populate this list -->
            </div>
        </div>
    </div>


    <!-- Firebase SDK and App Logic -->
    <script type="module">
        // Import Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, deleteDoc, onSnapshot, collection, query, where, serverTimestamp, getDocs, writeBatch, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Global variables ---
        let db, auth;
        let currentUser = null;
        let jobFilesCache = [];
        let clientsCache = [];
        let chargeDescriptions = [];
        let analyticsDataCache = null;
        let currentFilteredJobs = [];
        let fileIdToReject = null; 
        let profitChartInstance = null;

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyAAulR2nJQm-4QtNyEqKTnnDPw-iKW92Mc",
            authDomain: "my-job-file-system.firebaseapp.com",
            projectId: "my-job-file-system",
            storageBucket: "my-job-file-system.appspot.com",
            messagingSenderId: "145307873304",
            appId: "1:145307873304:web:d661ea6ec118801b4a136d",
            measurementId: "G-8EHX5K7YHL"
        };

        // --- Firebase Initialization ---
        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        const userDocRef = doc(db, 'users', user.uid);
                        let userDoc = await getDoc(userDocRef);
                        
                        if (!userDoc.exists()) {
                            const usersCollectionRef = collection(db, 'users');
                            const userQuerySnapshot = await getDocs(usersCollectionRef);
                            const isFirstUser = userQuerySnapshot.size === 0;

                            const newUser = {
                                email: user.email,
                                displayName: user.displayName || user.email.split('@')[0],
                                role: isFirstUser ? 'admin' : 'user',
                                status: isFirstUser ? 'active' : 'inactive',
                                createdAt: serverTimestamp()
                            };
                            await setDoc(userDocRef, newUser);
                            userDoc = await getDoc(userDocRef);
                        }
                        
                        currentUser = { uid: user.uid, email: user.email, ...userDoc.data() };
                        
                        if (currentUser.status === 'inactive') {
                            showLogin();
                            document.getElementById('approval-message').style.display = 'block';
                            document.getElementById('blocked-message').style.display = 'none';
                            signOut(auth);
                            return;
                        }

                        if (currentUser.status === 'blocked') {
                            showLogin();
                            document.getElementById('approval-message').style.display = 'none';
                            document.getElementById('blocked-message').style.display = 'block';
                            signOut(auth);
                            return;
                        }
                        
                        console.log("User logged in:", currentUser);
                        showApp();
                        loadJobFiles();
                        loadClients();
                    } else {
                        currentUser = null;
                        console.log("User logged out");
                        showLogin();
                    }
                });

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showNotification("Could not connect to the database.", true);
            }
        }

        // --- Function to handle public view from QR code ---
        async function initializeFirebaseAndShowPublicView(jobId) {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                await showPublicJobView(jobId);
            } catch (error)
            {
                console.error("Error initializing Firebase for public view:", error);
                document.body.innerHTML = `<div class="p-4 text-center text-red-700 bg-red-100">Could not load job file. Database connection failed.</div>`;
            } finally {
                hideLoader();
            }
        }

        async function showPublicJobView(jobId) {
            try {
                const docId = jobId.replace(/\//g, '_');
                const docRef = doc(db, 'jobfiles', docId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const publicViewHtml = getPrintViewHtml(data, true); 
                    
                    const publicViewContainer = document.getElementById('public-view-container');
                    publicViewContainer.innerHTML = publicViewHtml;
                } else {
                    document.body.innerHTML = `<div class="p-4 text-center text-yellow-700 bg-yellow-100">Job File with ID "${jobId}" not found.</div>`;
                }
            } catch (error) {
                console.error("Error fetching public job file:", error);
                document.body.innerHTML = `<div class="p-4 text-center text-red-700 bg-red-100">Error loading job file.</div>`;
            }
        }

        // --- Authentication Logic ---
        async function handleSignUp(email, password, displayName) {
            showLoader();
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                showNotification("Account created! Please wait for admin approval.", false);
                await signOut(auth);
                toggleAuthView(true);
            } catch (error) {
                console.error("Sign up error:", error);
                showNotification(error.message, true);
            }
            hideLoader();
        }

        async function handleLogin(email, password) {
            showLoader();
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error("Login error:", error);
                let message = "Login failed. Please check your email and password.";
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                    message = "Incorrect email or password. Please try again or reset your password.";
                }
                showNotification(message, true);
            }
            hideLoader();
        }
        
        async function handleForgotPassword() {
            const email = document.getElementById('reset-email').value.trim();
            if (!email) {
                showNotification("Please enter your email address.", true);
                return;
            }
            showLoader();
            try {
                await sendPasswordResetEmail(auth, email);
                hideLoader();
                closeModal('forgot-password-modal');
                showNotification("Password reset link sent! Check your email inbox.", false);
            } catch (error) {
                hideLoader();
                console.error("Password reset error:", error);
                let message = "Could not send reset link. Please try again.";
                if(error.code === 'auth/user-not-found'){
                    message = "No account found with this email address.";
                }
                showNotification(message, true);
            }
        }

        function handleLogout() {
            signOut(auth);
        }

        // --- Data Handling (Firestore) ---
        async function saveJobFile() {
            if (!db) { showNotification("Database not connected.", true); return; }
            
            const jobFileNoInput = document.getElementById('job-file-no');
            const jobFileNo = jobFileNoInput.value.trim();
            const isUpdating = jobFileNoInput.disabled;

            const invoiceNo = document.getElementById('invoice-no').value.trim();
            const mawbNo = document.getElementById('mawb').value.trim();

            if (!jobFileNo) { 
                showNotification("Please enter a Job File No.", true); 
                return; 
            }
            
            showLoader();
            const docId = jobFileNo.replace(/\//g, '_');

            const checks = [];
            if (!isUpdating) {
                 checks.push({ field: 'jfn', value: jobFileNo, label: 'Job File No.' });
            }
            if (invoiceNo) checks.push({ field: 'in', value: invoiceNo, label: 'Invoice No.' });
            if (mawbNo) checks.push({ field: 'mawb', value: mawbNo, label: 'MAWB No.' });

            for (const check of checks) {
                try {
                    const q = query(collection(db, 'jobfiles'), where(check.field, '==', check.value));
                    const querySnapshot = await getDocs(q);
                    
                    if (!querySnapshot.empty) {
                        if (isUpdating) {
                            for (const foundDoc of querySnapshot.docs) {
                                if (foundDoc.id !== docId) {
                                    hideLoader();
                                    showNotification(`Duplicate ${check.label} "${check.value}" found in job file: ${foundDoc.data().jfn}`, true);
                                    return;
                                }
                            }
                        } else {
                            hideLoader();
                            showNotification(`Duplicate ${check.label} "${check.value}" already exists in job file: ${querySnapshot.docs[0].data().jfn}`, true);
                            return;
                        }
                    }
                } catch (error) { 
                    hideLoader();
                    console.error("Error checking for duplicates:", error);
                    showNotification("Could not verify uniqueness. Please try again.", true);
                    return;
                }
            }

            const data = getFormData();
            data.totalCost = parseFloat(document.getElementById('total-cost').textContent) || 0;
            data.totalSelling = parseFloat(document.getElementById('total-selling').textContent) || 0;
            data.totalProfit = parseFloat(document.getElementById('total-profit').textContent) || 0;
            
            try {
                const docRef = doc(db, 'jobfiles', docId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const existingData = docSnap.data();
                    data.lastUpdatedBy = currentUser.displayName;
                    data.updatedAt = serverTimestamp();

                    if (existingData.status === 'approved' || existingData.status === 'checked') {
                        data.status = 'pending';
                        data.checkedBy = null;
                        data.checkedAt = null;
                        data.approvedBy = null;
                        data.approvedAt = null;
                        data.rejectionReason = null;
                        data.rejectedBy = null;
                        data.rejectedAt = null;
                        showNotification("File modified. Re-approval is now required.", false);
                    }
                    await setDoc(docRef, data, { merge: true });
                } else {
                    data.createdBy = currentUser.displayName;
                    data.createdAt = serverTimestamp();
                    data.lastUpdatedBy = currentUser.displayName;
                    data.updatedAt = serverTimestamp();
                    data.status = 'pending';
                    await setDoc(docRef, data);
                }
                
                hideLoader();
                showNotification("Job file saved successfully!");
                loadJobFileById(docId);

            } catch (error) {
                hideLoader();
                console.error("Error saving document: ", error);
                showNotification("Error saving job file.", true);
            }
        }
        
        async function checkJobFile(docId = null) {
            if (!currentUser || !['admin', 'checker'].includes(currentUser.role)) {
                showNotification("You do not have permission to check files.", true);
                return;
            }

            let fileId = docId;
            if (!fileId) {
                const jobFileNo = document.getElementById('job-file-no').value.trim();
                if (!jobFileNo) {
                    showNotification("Please save or load a job file first.", true);
                    return;
                }
                fileId = jobFileNo.replace(/\//g, '_');
            }
            
            showLoader();
            const checkData = {
                checkedBy: currentUser.displayName,
                checkedAt: serverTimestamp(),
                status: 'checked'
            };
            
            try {
                const docRef = doc(db, 'jobfiles', fileId);
                await setDoc(docRef, checkData, { merge: true });
                
                if (!docId) {
                    const updatedDoc = await getDoc(docRef);
                    populateFormFromData(updatedDoc.data());
                } else {
                    refreshOpenModals();
                }
                
                hideLoader();
                showNotification("Job File Checked!");

            } catch (error) {
                hideLoader();
                console.error("Error checking document: ", error);
                showNotification("Error checking job file.", true);
            }
        }

        async function uncheckJobFile(docId) {
            if (!currentUser || !['admin', 'checker'].includes(currentUser.role)) {
                showNotification("You do not have permission to uncheck files.", true);
                return;
            }
            showLoader();
            const uncheckData = {
                checkedBy: null,
                checkedAt: null,
                status: 'pending'
            };
            try {
                const docRef = doc(db, 'jobfiles', docId);
                await setDoc(docRef, uncheckData, { merge: true });
                hideLoader();
                showNotification("Job File Unchecked!");
                refreshOpenModals();
            } catch (error) {
                hideLoader();
                console.error("Error unchecking document: ", error);
                showNotification("Error unchecking job file.", true);
            }
        }

        async function approveJobFile(docId = null) {
            if (currentUser.role !== 'admin') {
                showNotification("Only admins can approve job files.", true);
                return;
            }
            
            let fileId = docId;
            if (!fileId) {
                const jobFileNo = document.getElementById('job-file-no').value.trim();
                 if (!jobFileNo) {
                    showNotification("Please save or load a job file first.", true);
                    return;
                }
                fileId = jobFileNo.replace(/\//g, '_');
            }

            showLoader();
            const approvalData = {
                approvedBy: currentUser.displayName,
                approvedAt: serverTimestamp(),
                status: 'approved',
                rejectionReason: null,
                rejectedBy: null,
                rejectedAt: null
            };
            
            try {
                const docRef = doc(db, 'jobfiles', fileId);
                await setDoc(docRef, approvalData, { merge: true });

                if (!docId) {
                    const updatedDoc = await getDoc(docRef);
                    populateFormFromData(updatedDoc.data());
                } else {
                    refreshOpenModals();
                }

                hideLoader();
                showNotification("Job File Approved!");

            } catch (error) {
                hideLoader();
                console.error("Error approving document: ", error);
                showNotification("Error approving job file.", true);
            }
        }

        function promptForRejection(docId) {
            fileIdToReject = docId;
            openModal('reject-reason-modal', true);
        }

        async function rejectJobFile() {
            const reason = document.getElementById('rejection-reason-input').value.trim();
            if (!reason) {
                showNotification("Rejection reason is required.", true);
                return;
            }

            const docId = fileIdToReject || document.getElementById('job-file-no').value.replace(/\//g, '_');
            if (!docId) {
                 showNotification("No file selected for rejection.", true);
                 return;
            }

            showLoader();
            const rejectionData = {
                rejectedBy: currentUser.displayName,
                rejectedAt: serverTimestamp(),
                rejectionReason: reason,
                status: 'rejected'
            };

            try {
                const docRef = doc(db, 'jobfiles', docId);
                await setDoc(docRef, rejectionData, { merge: true });
                
                if (fileIdToReject) {
                    refreshOpenModals();
                } else {
                    const updatedDoc = await getDoc(docRef);
                    populateFormFromData(updatedDoc.data());
                }
                
                hideLoader();
                closeModal('reject-reason-modal');
                document.getElementById('rejection-reason-input').value = '';
                fileIdToReject = null;
                showNotification("Job File Rejected!");
            } catch (error) {
                hideLoader();
                console.error("Error rejecting document: ", error);
                showNotification("Error rejecting job file.", true);
            }
        }

        function loadJobFiles() {
            if (!db) return;
            const jobFilesCollection = collection(db, 'jobfiles');
            const q = query(jobFilesCollection);

            onSnapshot(q, (querySnapshot) => {
                jobFilesCache = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                const sortedDocs = [...jobFilesCache].sort((a,b) => (b.updatedAt?.toDate ? b.updatedAt.toDate().getTime() : 0) - (a.updatedAt?.toDate ? a.updatedAt.toDate().getTime() : 0));
                
                displayJobFiles(sortedDocs);
                updateStatusSummary('status-summary-main', jobFilesCache);

            }, (error) => {
                console.error("Error fetching job files: ", error);
                showNotification("Error loading job files.", true);
            });
        }

        function displayJobFiles(files) {
            const list = document.getElementById('job-files-list');
            if (files.length === 0) {
                 list.innerHTML = `<p class="text-gray-500 text-center p-4">No job files match the current filters.</p>`;
                 return;
            }
            let filesHtml = '';
            files.forEach((docData) => {
                const deleteButton = currentUser.role === 'admin' ? `<button onclick="confirmDelete('${docData.id}')" class="bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded text-sm">Delete</button>` : '';
                const lastUpdated = docData.updatedAt?.toDate ? docData.updatedAt.toDate().toLocaleString() : 'N/A';
                
                const searchTerm = [docData.jfn, docData.sh, docData.co].join(' ').toLowerCase();

                filesHtml += `
                    <div class="job-file-item border p-3 rounded-lg flex flex-col sm:flex-row justify-between items-center bg-gray-50 hover:bg-gray-100 gap-2" 
                         data-search-term="${searchTerm}">
                        <div class="text-center sm:text-left">
                            <p class="font-bold text-indigo-700">${docData.jfn || 'No ID'}</p>
                            <p class="text-sm text-gray-600">Shipper: ${docData.sh || 'N/A'} | Consignee: ${docData.co || 'N/A'}</p>
                            <p class="text-xs text-gray-400">Last Updated: ${lastUpdated}</p>
                        </div>
                        <div class="space-x-2 flex-shrink-0">
                            <button onclick="previewJobFileById('${docData.id}')" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-1 px-3 rounded text-sm">Preview</button>
                            <button onclick="loadJobFileById('${docData.id}')" class="bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-3 rounded text-sm">Load</button>
                            ${deleteButton}
                        </div>
                    </div>
                `;
            });
            list.innerHTML = filesHtml;
        }

        function logUserActivity(jobFileNo) {
            if (!currentUser) return;

            const logEntry = {
                user: currentUser.displayName,
                file: jobFileNo,
                timestamp: new Date().toISOString()
            };

            let logs = [];
            try {
                const storedLogs = localStorage.getItem('userActivityLog');
                if (storedLogs) {
                    logs = JSON.parse(storedLogs);
                }
            } catch (e) {
                console.error("Error parsing user activity log from localStorage", e);
                logs = [];
            }

            logs.unshift(logEntry);

            if (logs.length > 200) {
                logs.splice(200);
            }

            localStorage.setItem('userActivityLog', JSON.stringify(logs));
        }
        
        function openUserActivityLog() {
            const logBody = document.getElementById('activity-log-body');
            let logs = [];
            try {
                const storedLogs = localStorage.getItem('userActivityLog');
                if (storedLogs) {
                    logs = JSON.parse(storedLogs);
                }
            } catch (e) {
                console.error("Error parsing user activity log from localStorage", e);
            }

            if (logs.length === 0) {
                logBody.innerHTML = '<tr><td colspan="3" class="table-cell text-center p-4">No user activity recorded yet.</td></tr>';
            } else {
                logBody.innerHTML = logs.map(entry => `
                    <tr class="border-b">
                        <td class="table-cell">${entry.user || 'Unknown'}</td>
                        <td class="table-cell font-medium">${entry.file || 'N/A'}</td>
                        <td class="table-cell text-gray-600">${new Date(entry.timestamp).toLocaleString()}</td>
                    </tr>
                `).join('');
            }

            openModal('activity-log-modal');
        }


        async function loadJobFileById(docId) {
            showLoader();
            try {
                const docRef = doc(db, 'jobfiles', docId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const fileData = docSnap.data();
                    populateFormFromData(fileData);
                    
                    logUserActivity(fileData.jfn);
                    
                    document.getElementById('job-file-no').disabled = true;
                    closeAllModals();
                    showNotification("Job file loaded successfully.");
                } else {
                    showNotification("Document not found.", true);
                }
                hideLoader();
            } catch (error) {
                hideLoader();
                console.error("Error loading document:", error);
                showNotification("Error loading job file.", true);
            }
        }

        async function previewJobFileById(docId) {
            showLoader();
            try {
                const docRef = doc(db, 'jobfiles', docId);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const previewBody = document.getElementById('preview-body');
                    previewBody.innerHTML = getPrintViewHtml(data, false); 
                    
                    const qrContainer = previewBody.querySelector('.qrcode-container');
                    if (qrContainer && data.jfn) {
                        qrContainer.innerHTML = '';
                        const baseUrl = window.location.href.split('?')[0];
                        const qrText = `${baseUrl}?jobId=${encodeURIComponent(data.jfn)}`;
                        new QRCode(qrContainer, {
                            text: qrText,
                            width: 96,
                            height: 96,
                            correctLevel: QRCode.CorrectLevel.H
                        });
                    }
                    
                    openModal('preview-modal', true); // Pass true to keep parent modals open
                } else {
                    showNotification("Document not found.", true);
                }
                hideLoader();
            } catch (error) {
                hideLoader();
                console.error("Error previewing document:", error);
                showNotification("Error previewing job file.", true);
            }
        }
        
        async function moveToRecycleBin(docId) {
            showLoader();
            try {
                const docRef = doc(db, 'jobfiles', docId);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const dataToMove = docSnap.data();
                    dataToMove.deletedAt = serverTimestamp();
                    dataToMove.deletedBy = currentUser.displayName;
                    
                    const deletedDocRef = doc(db, 'deleted_jobfiles', docId);
                    await setDoc(deletedDocRef, dataToMove);
                    await deleteDoc(docRef);
                    
                    showNotification("Job file moved to recycle bin.");
                } else {
                    throw new Error("Document not found in main collection.");
                }
            } catch (error) {
                console.error("Error moving to recycle bin:", error);
                showNotification("Error deleting job file.", true);
            } finally {
                hideLoader();
            }
        }

        function confirmDelete(docId, type = 'jobfile') {
             if (currentUser.role !== 'admin') {
                 showNotification("Only admins can delete files.", true);
                 return;
            }
            const modal = document.getElementById('confirm-modal');
            let message = '';
            let onOk;

            if (type === 'jobfile') {
                modal.querySelector('#confirm-title').textContent = 'Confirm Job File Deletion';
                message = `Are you sure you want to move job file "${docId.replace(/_/g, '/')}" to the recycle bin?`;
                onOk = () => moveToRecycleBin(docId);
            } else if (type === 'client') {
                modal.querySelector('#confirm-title').textContent = 'Confirm Client Deletion';
                const client = clientsCache.find(c => c.id === clientId);
                message = `Are you sure you want to delete the client "${client?.name || 'this client'}"? This action cannot be undone.`;
                onOk = () => deleteClient(docId);
            }

            modal.querySelector('#confirm-message').innerHTML = message;
            modal.querySelector('#confirm-ok').className = 'bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded';
            openModal('confirm-modal', true);

            const okButton = modal.querySelector('#confirm-ok');
            const cancelButton = modal.querySelector('#confirm-cancel');

            const handleOkClick = () => {
                onOk();
                closeConfirm();
            };
            const closeConfirm = () => {
                closeModal('confirm-modal');
                okButton.removeEventListener('click', handleOkClick);
            };
            
            okButton.addEventListener('click', handleOkClick, { once: true });
            cancelButton.addEventListener('click', closeConfirm, { once: true });
        }

        // --- Analytics Dashboard Logic ---
        function openAnalyticsDashboard() {
            const dateType = document.getElementById('analytics-date-type')?.value || 'bd';
            filterAnalyticsByTimeframe('all', dateType);
            document.getElementById('app-container').style.display = 'none';
            document.getElementById('analytics-container').style.display = 'block';
            window.scrollTo(0, 0);
        }

        function filterAnalyticsByTimeframe(timeframe, dateType = 'bd') {
            currentFilteredJobs = jobFilesCache;
            const now = new Date();
            const currentYear = now.getFullYear();
            const lastYear = currentYear - 1;

            if (timeframe !== 'all') {
                currentFilteredJobs = jobFilesCache.filter(job => {
                    const dateField = dateType === 'bd' ? job.bd : job.d;
                    if (!dateField) return false;
                    const jobDate = new Date(dateField);
                    if (timeframe === 'thisYear') {
                        return jobDate.getFullYear() === currentYear;
                    }
                    if (timeframe === 'lastYear') {
                        return jobDate.getFullYear() === lastYear;
                    }
                    if (timeframe.includes('-')) { // Monthly filter like '2025-01'
                        const [year, month] = timeframe.split('-').map(Number);
                        return jobDate.getFullYear() === year && jobDate.getMonth() === month - 1;
                    }
                    return true;
                });
            }
            calculateAndDisplayAnalytics(currentFilteredJobs);
        }


        function calculateAndDisplayAnalytics(jobs) {
            const body = document.getElementById('analytics-body');
             if (jobs.length === 0) {
                 body.innerHTML = `
                <!-- Timeframe Filters -->
                <div class="space-y-3">
                    <div class="flex items-center justify-center gap-4">
                         <label for="analytics-date-type" class="text-sm font-medium">Report Date Type:</label>
                         <select id="analytics-date-type" class="input-field w-auto">
                             <option value="bd">Billing Date</option>
                             <option value="d">Opening Date</option>
                         </select>
                    </div>
                    <div class="flex justify-center flex-wrap gap-2">
                        <button data-timeframe="all" class="timeframe-btn bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded">All Time</button>
                        <button data-timeframe="thisYear" class="timeframe-btn bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded">This Year</button>
                        <button data-timeframe="lastYear" class="timeframe-btn bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded">Last Year</button>
                    </div>
                </div>
                 <p class="text-center text-gray-500 mt-8">No data available for the selected period.</p>`;
                
                 document.querySelectorAll('.timeframe-btn').forEach(btn => {
                     btn.addEventListener('click', (e) => {
                         const timeframe = e.target.dataset.timeframe;
                         const dateType = document.getElementById('analytics-date-type').value;
                         filterAnalyticsByTimeframe(timeframe, dateType);
                     });
                 });
                 document.getElementById('analytics-date-type').addEventListener('change', (e) => {
                      const activeTimeframeButton = document.querySelector('.timeframe-btn.bg-indigo-700') || document.querySelector('[data-timeframe="all"]');
                      filterAnalyticsByTimeframe(activeTimeframeButton.dataset.timeframe, e.target.value);
                 });
                 return;
            }

            let totalJobs = jobs.length;
            let totalRevenue = 0;
            let totalCost = 0;
            let totalProfit = 0;
            const profitByFile = [];
            const profitByShipper = {};
            const profitByConsignee = {};
            const monthlyStatsByBilling = {};
            const monthlyStatsByOpening = {};
            const profitByUser = {};
            const profitBySalesman = {};

            jobs.forEach(job => {
                const profit = job.totalProfit || 0;
                const revenue = job.totalSelling || 0;
                const cost = job.totalCost || 0;
                const creator = job.createdBy || 'Unknown';
                const salesman = job.sm || 'N/A';
                let status = 'Pending Check';
                if (job.status === 'rejected') status = 'Rejected';
                else if (job.status === 'approved') status = 'Approved';
                else if (job.status === 'checked') status = 'Checked';

                totalRevenue += revenue;
                totalCost += cost;
                totalProfit += profit;

                profitByFile.push({ id: job.id, jfn: job.jfn, shipper: job.sh, consignee: job.co, profit: profit, status: status, date: job.updatedAt?.toDate() || new Date(0), cost: cost, dsc: job.dsc, mawb: job.mawb, createdBy: creator });

                if (job.sh) {
                    profitByShipper[job.sh] = (profitByShipper[job.sh] || 0) + profit;
                }
                if (job.co) {
                    profitByConsignee[job.co] = (profitByConsignee[job.co] || 0) + profit;
                }
                if (job.bd) {
                    const month = job.bd.substring(0, 7);
                    if (!monthlyStatsByBilling[month]) {
                        monthlyStatsByBilling[month] = { profit: 0, count: 0, jobs: [] };
                    }
                    monthlyStatsByBilling[month].profit += profit;
                    monthlyStatsByBilling[month].count++;
                    monthlyStatsByBilling[month].jobs.push(job);
                }
                if (job.d) {
                    const month = job.d.substring(0, 7);
                    if (!monthlyStatsByOpening[month]) {
                        monthlyStatsByOpening[month] = { profit: 0, count: 0, jobs: [] };
                    }
                    monthlyStatsByOpening[month].profit += profit;
                    monthlyStatsByOpening[month].count++;
                    monthlyStatsByOpening[month].jobs.push(job);
                }
                
                if (!profitByUser[creator]) {
                    profitByUser[creator] = { count: 0, profit: 0, jobs: [] };
                }
                profitByUser[creator].count++;
                profitByUser[creator].profit += profit;
                profitByUser[creator].jobs.push(job);

                if (salesman !== 'N/A') {
                    if (!profitBySalesman[salesman]) {
                        profitBySalesman[salesman] = { count: 0, profit: 0, jobs: [] };
                    }
                    profitBySalesman[salesman].count++;
                    profitBySalesman[salesman].profit += profit;
                    profitBySalesman[salesman].jobs.push(job);
                }
            });

            analyticsDataCache = {
                totalJobs, totalRevenue, totalCost, totalProfit, profitByFile,
                profitByShipper: Object.entries(profitByShipper).sort((a, b) => b[1] - a[1]),
                profitByConsignee: Object.entries(profitByConsignee).sort((a, b) => b[1] - a[1]),
                monthlyStatsByBilling: Object.entries(monthlyStatsByBilling).sort((a, b) => a[0].localeCompare(b[0])),
                monthlyStatsByOpening: Object.entries(monthlyStatsByOpening).sort((a, b) => a[0].localeCompare(b[0])),
                profitByUser: Object.entries(profitByUser).sort((a, b) => b[1].profit - a[1].profit),
                profitBySalesman: Object.entries(profitBySalesman).sort((a, b) => b[1].profit - a[1].profit)
            };

            displayAnalytics(analyticsDataCache);
        }

        function closeAnalyticsDashboard() {
            document.getElementById('analytics-container').style.display = 'none';
            document.getElementById('app-container').style.display = 'block';
        }
        
        function renderProfitChart(data, monthlyReportType) {
            if (profitChartInstance) {
                profitChartInstance.destroy();
            }

            const ctx = document.getElementById('profit-chart')?.getContext('2d');
            if (!ctx) return;
            
            const monthlyStats = monthlyReportType === 'billing' ? data.monthlyStatsByBilling : data.monthlyStatsByOpening;
            
            let year;
            if (currentFilteredJobs.length > 0) {
                 const dateField = monthlyReportType === 'billing' ? currentFilteredJobs[0].bd : currentFilteredJobs[0].d;
                 if(dateField) year = new Date(dateField).getFullYear();
            }
            if (!year) year = new Date().getFullYear();


            const labels = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            const profits = Array(12).fill(0);
            
            monthlyStats.forEach(([monthStr, stats]) => {
                const [statYear, statMonth] = monthStr.split('-').map(Number);
                if (statYear === year) {
                    profits[statMonth - 1] = stats.profit;
                }
            });

            const maxProfit = Math.max(...profits.map(p => Math.abs(p)));

            const backgroundColors = profits.map(p => {
                if (p === 0) return 'rgba(201, 203, 207, 0.6)';
                const alpha = Math.max(0.2, Math.abs(p) / (maxProfit || 1));
                return p > 0 ? `rgba(75, 192, 192, ${alpha})` : `rgba(255, 99, 132, ${alpha})`;
            });

            profitChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `Monthly Profit for ${year}`,
                        data: profits,
                        backgroundColor: backgroundColors,
                        borderColor: backgroundColors.map(c => c.replace('0.6', '1').replace('0.2','1')),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value, index, values) {
                                    return 'KD ' + value;
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                             callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += 'KD ' + context.parsed.y.toFixed(3);
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }


        function displayAnalytics(data, sortBy = 'profit-desc', searchTerm = '', monthlyReportType = 'billing') {
            const body = document.getElementById('analytics-body');
            
            let filteredFiles = data.profitByFile;

            if (searchTerm) {
                const lowerCaseSearchTerm = searchTerm.toLowerCase();
                filteredFiles = data.profitByFile.filter(file => 
                    (file.jfn || '').toLowerCase().includes(lowerCaseSearchTerm) ||
                    (file.shipper || '').toLowerCase().includes(lowerCaseSearchTerm) ||
                    (file.consignee || '').toLowerCase().includes(lowerCaseSearchTerm) ||
                    (file.mawb || '').toLowerCase().includes(lowerCaseSearchTerm) ||
                    (file.createdBy || '').toLowerCase().includes(lowerCaseSearchTerm)
                );
            }
            
            const monthlyStats = monthlyReportType === 'billing' ? data.monthlyStatsByBilling : data.monthlyStatsByOpening;
            const monthlyReportTitle = monthlyReportType === 'billing' ? 'Profit By Month (Billing Date)' : 'Profit By Month (Opening Date)';

            const now = new Date();
            const currentYear = now.getFullYear();
            const lastYear = currentYear - 1;
            const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            let monthButtons = '';
            for(let i=0; i < 12; i++) {
                const monthStr = `${currentYear}-${String(i + 1).padStart(2, '0')}`;
                monthButtons += `<button data-timeframe="${monthStr}" class="timeframe-btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-1 px-3 rounded text-sm">${months[i]}</button>`;
            }


            const sortedFiles = [...filteredFiles];
            if (sortBy === 'profit-desc') {
                sortedFiles.sort((a, b) => b.profit - a.profit);
            } else if (sortBy === 'date-desc') {
                sortedFiles.sort((a, b) => b.date - a.date);
            } else if (sortBy === 'status') {
                const statusOrder = { 'Pending Check': 1, 'Checked': 2, 'Approved': 3, 'Rejected': 4 };
                sortedFiles.sort((a, b) => (statusOrder[a.status] || 99) - (statusOrder[b.status] || 99));
            } else if (sortBy === 'user') {
                sortedFiles.sort((a, b) => (a.createdBy || '').localeCompare(b.createdBy || ''));
            }

            body.innerHTML = `
                <!-- Timeframe Filters -->
                <div class="space-y-3">
                    <div class="flex items-center justify-center gap-4">
                         <label for="analytics-date-type" class="text-sm font-medium">Report Date Type:</label>
                         <select id="analytics-date-type" class="input-field w-auto">
                             <option value="bd" ${monthlyReportType === 'bd' ? 'selected' : ''}>Billing Date</option>
                             <option value="d" ${monthlyReportType === 'd' ? 'selected' : ''}>Opening Date</option>
                         </select>
                    </div>
                    <div class="flex justify-center flex-wrap gap-2">
                        <button data-timeframe="all" class="timeframe-btn bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded">All Time</button>
                        <button data-timeframe="thisYear" class="timeframe-btn bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded">This Year</button>
                        <button data-timeframe="lastYear" class="timeframe-btn bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded">Last Year</button>
                    </div>
                    <div class="flex justify-center flex-wrap gap-1">
                        ${monthButtons}
                    </div>
                </div>
                <!-- Overall Summary -->
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 text-center mt-6">
                    <div class="bg-gray-100 p-4 rounded-lg"><p class="text-sm text-gray-600">Total Jobs</p><p class="text-2xl font-bold">${data.totalJobs}</p></div>
                    <div class="bg-blue-100 p-4 rounded-lg"><p class="text-sm text-blue-800">Total Revenue</p><p class="text-2xl font-bold text-blue-900">KD ${data.totalRevenue.toFixed(3)}</p></div>
                    <div class="bg-red-100 p-4 rounded-lg"><p class="text-sm text-red-800">Total Cost</p><p class="text-2xl font-bold text-red-900">KD ${data.totalCost.toFixed(3)}</p></div>
                    <div class="bg-green-100 p-4 rounded-lg"><p class="text-sm text-green-800">Total Profit</p><p class="text-2xl font-bold text-green-900">KD ${data.totalProfit.toFixed(3)}</p></div>
                </div>
                 <!-- Profit Chart -->
                 <div class="bg-white p-4 rounded-lg shadow-sm">
                     <div style="position: relative; height:300px;">
                         <canvas id="profit-chart"></canvas>
                     </div>
                 </div>

                <!-- Detailed Breakdowns -->
                <div id="analytics-tables" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div>
                        <h4 class="text-lg font-semibold mb-2">Top Profitable Shippers</h4>
                        <div class="overflow-x-auto"><table class="analytics-table w-full"><thead><tr><th>Shipper</th><th>Total Profit</th></tr></thead>
                        <tbody>${data.profitByShipper.slice(0, 5).map(([name, profit]) => `<tr><td>${name}</td><td>KD ${profit.toFixed(3)}</td></tr>`).join('')}</tbody></table></div>
                    </div>
                    <div>
                        <h4 class="text-lg font-semibold mb-2">Top Profitable Consignees</h4>
                        <div class="overflow-x-auto"><table class="analytics-table w-full"><thead><tr><th>Consignee</th><th>Total Profit</th></tr></thead>
                        <tbody>${data.profitByConsignee.slice(0, 5).map(([name, profit]) => `<tr><td>${name}</td><td>KD ${profit.toFixed(3)}</td></tr>`).join('')}</tbody></table></div>
                    </div>
                     <div>
                        <h4 class="text-lg font-semibold mb-2">Top Salesmen by Profit</h4>
                        <div class="overflow-x-auto"><table class="analytics-table w-full"><thead><tr><th>Salesman</th><th>Files</th><th>Profit</th><th>Actions</th></tr></thead>
                        <tbody>${data.profitBySalesman.slice(0, 5).map(([name, stats]) => `<tr><td>${name}</td><td>${stats.count}</td><td>KD ${stats.profit.toFixed(3)}</td><td><button data-action="view-salesman-jobs" data-salesman="${name}" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-1 px-2 rounded text-xs">View Jobs</button></td></tr>`).join('')}</tbody></table></div>
                    </div>
                    <div class="lg:col-span-3">
                         <h4 class="text-lg font-semibold mb-2">${monthlyReportTitle}</h4>
                        <div class="overflow-x-auto"><table class="analytics-table w-full"><thead><tr><th>Month</th><th>Total Jobs</th><th>Total Profit / Loss</th><th>Actions</th></tr></thead>
                        <tbody>${monthlyStats.map(([month, stats]) => `<tr><td>${month}</td><td>${stats.count}</td><td>KD ${stats.profit.toFixed(3)}</td><td><button data-action="view-monthly-jobs" data-month="${month}" data-datetype="${monthlyReportType}" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-1 px-2 rounded text-xs">View Jobs</button></td></tr>`).join('')}</tbody></table></div>
                    </div>
                     <div class="lg:col-span-3">
                        <h4 class="text-lg font-semibold mb-2">Top Users by Profit</h4>
                        <div class="overflow-x-auto"><table class="analytics-table w-full"><thead><tr><th>User</th><th>Files</th><th>Profit</th><th>Actions</th></tr></thead>
                        <tbody>${data.profitByUser.map(([name, stats]) => `<tr><td>${name}</td><td>${stats.count}</td><td>KD ${stats.profit.toFixed(3)}</td><td><button data-action="view-user-jobs" data-user="${name}" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-1 px-2 rounded text-xs">View Jobs</button></td></tr>`).join('')}</tbody></table></div>
                    </div>
                </div>

                <!-- Profit by Job File -->
                <div>
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-2 gap-2">
                        <h4 class="text-lg font-semibold">Job File Details</h4>
                        <div class="flex items-center gap-2 flex-grow">
                            <input type="text" id="analytics-search-bar" class="input-field w-full sm:w-auto flex-grow" placeholder="Search files..." value="${searchTerm}">
                            <label for="sort-analytics" class="text-sm ml-4 mr-2">Sort by:</label>
                            <select id="sort-analytics" class="input-field w-auto inline-block text-sm">
                                <option value="profit-desc" ${sortBy === 'profit-desc' ? 'selected' : ''}>Profit (High to Low)</option>
                                <option value="date-desc" ${sortBy === 'date-desc' ? 'selected' : ''}>Date (Newest First)</option>
                                <option value="status" ${sortBy === 'status' ? 'selected' : ''}>Status</option>
                                <option value="user" ${sortBy === 'user' ? 'selected' : ''}>User</option>
                            </select>
                            <button onclick="downloadAnalyticsCsv()" class="bg-gray-700 hover:bg-gray-800 text-white font-bold py-1 px-3 rounded text-sm">CSV</button>
                        </div>
                    </div>
                    <div class="max-h-96 overflow-y-auto">
                        <table class="analytics-table w-full text-sm">
                            <thead><tr><th>Job Details</th><th>Cost / Profit</th><th>Status</th><th>Actions</th></tr></thead>
                            <tbody>${sortedFiles.length > 0 ? sortedFiles.map(file => `
                                <tr>
                                    <td>
                                        <p class="font-bold">${file.jfn || file.id}</p>
                                        <p class="text-xs">Shipper: ${file.shipper || 'N/A'}</p>
                                        <p class="text-xs">Consignee: ${file.consignee || 'N/A'}</p>
                                        <p class="text-xs text-gray-600">AWB/MAWB: ${file.mawb || 'N/A'}</p>
                                        <p class="text-xs text-gray-600">Desc: ${file.dsc || 'N/A'}</p>
                                        <p class="text-xs font-bold mt-1">Created by: ${file.createdBy || 'N/A'}</p>
                                    </td>
                                    <td>
                                        <p class="font-bold text-green-600">KD ${file.profit.toFixed(3)}</p>
                                        <p class="text-xs text-red-600">Cost: KD ${file.cost.toFixed(3)}</p>
                                    </td>
                                    <td>${file.status}</td>
                                    <td class="space-x-1">
                                        <button onclick="previewJobFileById('${file.id}')" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-1 px-2 rounded text-xs">Preview</button>
                                        <button onclick="loadJobFileById('${file.id}')" class="bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-2 rounded text-xs">Load</button>
                                        ${currentUser.role === 'admin' ? `<button onclick="confirmDelete('${file.id}')" class="bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-2 rounded text-xs">Delete</button>` : ''}
                                    </td>
                                </tr>`).join('') : `<tr><td colspan="4" class="text-center py-4">No files match your search.</td></tr>`}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            renderProfitChart(data, monthlyReportType);

            document.getElementById('analytics-search-bar').addEventListener('input', (e) => {
                displayAnalytics(analyticsDataCache, document.getElementById('sort-analytics').value, e.target.value, document.getElementById('analytics-date-type').value);
            });
            document.getElementById('sort-analytics').addEventListener('change', (e) => {
                 displayAnalytics(analyticsDataCache, e.target.value, document.getElementById('analytics-search-bar').value, document.getElementById('analytics-date-type').value);
            });
             document.getElementById('analytics-date-type').addEventListener('change', (e) => {
                 const activeTimeframeButton = document.querySelector('.timeframe-btn.bg-indigo-700') || document.querySelector('[data-timeframe="all"]');
                 filterAnalyticsByTimeframe(activeTimeframeButton.dataset.timeframe, e.target.value);
            });

            document.querySelectorAll('.timeframe-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                     document.querySelectorAll('.timeframe-btn').forEach(b => {
                         b.classList.remove('bg-indigo-700', 'text-white');
                         if(!b.classList.contains('bg-gray-200')) {
                             b.classList.add('bg-indigo-500');
                         }
                     });
                     e.target.classList.remove('bg-indigo-500', 'bg-gray-200');
                     e.target.classList.add('bg-indigo-700', 'text-white');
                    const timeframe = e.target.dataset.timeframe;
                    const dateType = document.getElementById('analytics-date-type').value;
                    filterAnalyticsByTimeframe(timeframe, dateType);
                });
            });

            document.getElementById('analytics-tables').addEventListener('click', (e) => {
                const target = e.target;
                if (target.tagName === 'BUTTON' && target.dataset.action) {
                    const action = target.dataset.action;
                    if (action === 'view-user-jobs') {
                        showUserJobs(target.dataset.user);
                    } else if (action === 'view-monthly-jobs') {
                        showMonthlyJobs(target.dataset.month, target.dataset.datetype);
                    } else if (action === 'view-salesman-jobs') {
                        showSalesmanJobs(target.dataset.salesman);
                    }
                }
            });

        }
        
        function sortAnalyticsTable(sortBy) {
            const searchTerm = document.getElementById('analytics-search-bar').value;
            displayAnalytics(analyticsDataCache, sortBy, searchTerm, document.getElementById('analytics-date-type').value);
        }
        
        function downloadAnalyticsCsv() {
            let csvContent = "data:text/csv;charset=utf-8,Job File ID,Shipper,Consignee,Profit,Status,Cost,Description,AWB/MAWB,Created By\n";
            const sortedFiles = [...analyticsDataCache.profitByFile].sort((a,b) => (b.profit || 0) - (a.profit || 0));

            sortedFiles.forEach(job => {
                const rowData = [job.jfn, job.shipper || 'N/A', job.consignee || 'N/A', (job.profit || 0).toFixed(3), job.status, (job.cost || 0).toFixed(3), job.dsc || 'N/A', job.mawb || 'N/A', job.createdBy || 'N/A'];
                const row = rowData.map(d => `"${String(d).replace(/"/g, '""')}"`).join(",");
                csvContent += row + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "job_file_analytics.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- Admin Panel & Backup/Restore Logic ---
        async function openAdminPanel() {
            if (currentUser.role !== 'admin') {
                showNotification("Access denied.", true);
                return;
            }
            showLoader();
            const usersCollectionRef = collection(db, 'users');
            const userQuerySnapshot = await getDocs(usersCollectionRef);
            const userListDiv = document.getElementById('user-list');
            let userListHtml = '';

            userQuerySnapshot.forEach(doc => {
                const userData = doc.data();
                const userId = doc.id;
                const isDisabled = userId === currentUser.uid;
                userListHtml += `
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 items-center p-2 border-b">
                        <input type="text" data-uid="${userId}" class="display-name-input input-field col-span-1" value="${userData.displayName}" ${isDisabled ? 'disabled' : ''}>
                        <select data-uid="${userId}" class="role-select input-field col-span-1" ${isDisabled ? 'disabled' : ''}>
                            <option value="user" ${userData.role === 'user' ? 'selected' : ''}>User</option>
                            <option value="checker" ${userData.role === 'checker' ? 'selected' : ''}>Checker</option>
                            <option value="driver" ${userData.role === 'driver' ? 'selected' : ''}>Driver</option>
                            <option value="warehouse_supervisor" ${userData.role === 'warehouse_supervisor' ? 'selected' : ''}>Warehouse Supervisor</option>
                            <option value="admin" ${userData.role === 'admin' ? 'selected' : ''}>Admin</option>
                        </select>
                        <select data-uid="${userId}" class="status-select input-field col-span-1" ${isDisabled ? 'disabled' : ''}>
                            <option value="active" ${userData.status === 'active' ? 'selected' : ''}>Active</option>
                            <option value="inactive" ${userData.status === 'inactive' ? 'selected' : ''}>Inactive</option>
                            <option value="blocked" ${userData.status === 'blocked' ? 'selected' : ''}>Blocked</option>
                        </select>
                    </div>
                `;
            });
            userListDiv.innerHTML = userListHtml;
            hideLoader();
            openModal('admin-panel-modal');
        }

        async function saveUserChanges() {
            showLoader();
            const batch = writeBatch(db);
            const userRows = document.querySelectorAll('#user-list > div');
            
            userRows.forEach(row => {
                const nameInput = row.querySelector('.display-name-input');
                if (nameInput.disabled) return;

                const roleSelect = row.querySelector('.role-select');
                const statusSelect = row.querySelector('.status-select');
                const uid = nameInput.dataset.uid;
                
                const userDocRef = doc(db, 'users', uid);
                batch.update(userDocRef, { 
                    displayName: nameInput.value,
                    role: roleSelect.value,
                    status: statusSelect.value
                });
            });

            try {
                await batch.commit();
                hideLoader();
                showNotification("User details updated successfully!");
                closeModal('admin-panel-modal');
            } catch (error) {
                hideLoader();
                console.error("Error updating roles: ", error);
                showNotification("Failed to update user details.", true);
            }
        }

        async function backupAllData() {
            if (currentUser.role !== 'admin') {
                showNotification("Access denied. Only admins can perform backups.", true);
                return;
            }
            showLoader();
            try {
                const jobFilesQuery = query(collection(db, 'jobfiles'));
                const usersQuery = query(collection(db, 'users'));

                const jobFilesSnapshot = await getDocs(jobFilesQuery);
                const usersSnapshot = await getDocs(usersQuery);

                const jobfilesData = jobFilesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const usersData = usersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                const backupData = {
                    version: "1.0",
                    createdAt: new Date().toISOString(),
                    data: {
                        jobfiles: jobfilesData,
                        users: usersData
                    }
                };

                const jsonString = JSON.stringify(backupData, (key, value) => {
                    if (value && typeof value.toDate === 'function') {
                        return value.toDate().toISOString();
                    }
                    return value;
                }, 2);

                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                const date = new Date().toISOString().slice(0, 10);
                link.download = `qgo-cargo-backup-${date}.json`;
                link.href = url;
                link.click();
                URL.revokeObjectURL(url);

                showNotification("Backup created and download started successfully.");

            } catch (error) {
                console.error("Backup failed:", error);
                showNotification("An error occurred during backup.", true);
            } finally {
                hideLoader();
            }
        }

        async function handleRestoreFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (currentUser.role !== 'admin') {
                showNotification("Access denied. Only admins can restore data.", true);
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                const content = e.target.result;
                try {
                    const backupData = JSON.parse(content);

                    if (!backupData.data || !backupData.data.jobfiles || !backupData.data.users) {
                        showNotification("Invalid backup file format.", true);
                        return;
                    }

                    const jobFileCount = backupData.data.jobfiles.length;
                    const userCount = backupData.data.users.length;

                    const modal = document.getElementById('confirm-modal');
                    modal.querySelector('#confirm-title').textContent = 'Confirm Data Restore';
                    modal.querySelector('#confirm-message').innerHTML = `
                        <p>You are about to restore <b>${jobFileCount} job files</b> and <b>${userCount} users</b> from the selected file.</p>
                        <p class="mt-2">This will <b class="underline">overwrite any existing data</b> with the content from the backup file. Documents not in the backup file will not be affected.</p>
                        <p class="mt-2 text-red-600 font-bold">This action cannot be undone. Are you sure you want to proceed?</p>
                    `;
                    modal.querySelector('#confirm-ok').className = 'bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded';
                    openModal('confirm-modal');

                    const okButton = modal.querySelector('#confirm-ok');
                    const cancelButton = modal.querySelector('#confirm-cancel');

                    const onOk = async () => {
                        closeConfirm();
                        showLoader();
                        try {
                            const restoreBatch = writeBatch(db);
                            
                            backupData.data.jobfiles.forEach(jobFile => {
                                const docRef = doc(db, 'jobfiles', jobFile.id);
                                const { id, ...dataToRestore } = jobFile;
                                restoreBatch.set(docRef, dataToRestore);
                            });

                            backupData.data.users.forEach(user => {
                                const docRef = doc(db, 'users', user.id);
                                const { id, ...dataToRestore } = user;
                                restoreBatch.set(docRef, dataToRestore);
                            });

                            await restoreBatch.commit();
                            showNotification("Data restored successfully! The page will now reload.");
                            setTimeout(() => window.location.reload(), 2000);

                        } catch (error) {
                            console.error("Restore failed:", error);
                            showNotification("An error occurred during restore. Data may be partially restored.", true);
                        } finally {
                            hideLoader();
                        }
                    };

                    const closeConfirm = () => {
                        closeModal('confirm-modal');
                        okButton.removeEventListener('click', onOk);
                    };

                    okButton.addEventListener('click', onOk, { once: true });
                    cancelButton.addEventListener('click', closeConfirm, { once: true });

                } catch (error) {
                    console.error("Error reading restore file:", error);
                    showNotification("Failed to read or parse the backup file. Please ensure it's a valid JSON backup.", true);
                } finally {
                    event.target.value = '';
                }
            };

            reader.readAsText(file);
        }


        // --- UI Functions ---
        function showLogin() {
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('app-container').style.display = 'none';
            document.getElementById('analytics-container').style.display = 'none';
        }

        function showApp() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-container').style.display = 'block';
            document.getElementById('analytics-container').style.display = 'none';
            document.getElementById('user-display-name').textContent = currentUser.displayName;
            document.getElementById('user-role').textContent = currentUser.role;

            document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.checker-only').forEach(el => el.style.display = 'none');
            
            if (currentUser.role === 'admin') {
                document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'block');
                document.querySelectorAll('.checker-only').forEach(el => el.style.display = 'block');
                document.getElementById('checker-info-banner').style.display = 'block';
            } else if (currentUser.role === 'checker') {
                document.querySelectorAll('.checker-only').forEach(el => el.style.display = 'block');
                document.getElementById('checker-info-banner').style.display = 'block';
            }
            
            clearForm();
        }

        function closeAllModals() {
            document.querySelectorAll('.overlay').forEach(modal => {
                modal.classList.remove('visible');
                modal.style.zIndex = ''; 
            });
        }

        function getHighestZIndex() {
            let highest = 1000;
            document.querySelectorAll('.overlay.visible').forEach(modal => {
                const z = parseInt(window.getComputedStyle(modal).zIndex, 10);
                if (z > highest) {
                    highest = z;
                }
            });
            return highest;
        }

        function openModal(id, keepParent = false) {
            if (!keepParent) {
                closeAllModals();
            }
            const modal = document.getElementById(id);
            if (keepParent) {
                const highestZ = getHighestZIndex();
                modal.style.zIndex = highestZ + 1;
            }
            modal.classList.add('visible');
        }
        function closeModal(id) {
            const modal = document.getElementById(id);
            modal.classList.remove('visible');
            modal.style.zIndex = '';
        }
        
        function clearForm() {
            const form = document.querySelector('#main-container');
            form.querySelectorAll('input[type="text"], input[type="date"], textarea').forEach(input => input.value = '');
            form.querySelectorAll('input[type="checkbox"]').forEach(checkbox => checkbox.checked = false);
            
            document.getElementById('date').valueAsDate = new Date();
            document.getElementById('job-file-no').disabled = false;
            populateTable();
            calculate();
            
            document.getElementById('prepared-by').value = currentUser.displayName;
            
            document.getElementById('created-by-info').textContent = '';
            document.getElementById('last-updated-by-info').textContent = '';

            document.getElementById('approved-by').value = '';
            document.getElementById('checked-by').value = '';
            document.getElementById('check-btn').disabled = false;
            document.getElementById('check-btn').textContent = 'Check Job File';
            document.getElementById('approve-btn').disabled = false;
            document.getElementById('reject-btn').disabled = false;

            document.getElementById('checked-stamp').style.display = 'none';
            document.getElementById('approved-stamp').style.display = 'none';
            document.getElementById('rejected-stamp').style.display = 'none';
            document.getElementById('rejection-banner').style.display = 'none';

            const isChecker = ['admin', 'checker'].includes(currentUser.role);
            const isAdmin = currentUser.role === 'admin';
            document.getElementById('check-btn').style.display = isChecker ? 'block' : 'none';
            document.getElementById('approval-buttons').style.display = isAdmin ? 'flex' : 'none';

            showNotification("Form cleared. Ready for a new job file.");
        }

        function showLoader() { document.getElementById('loader-overlay').classList.add('visible'); }
        function hideLoader() { document.getElementById('loader-overlay').classList.remove('visible'); }

        function showNotification(message, isError = false) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.backgroundColor = isError ? '#c53030' : '#2d3748';
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function applyFiltersAndDisplay() {
            const searchTerm = document.getElementById('search-bar').value.toLowerCase();
            const statusFilter = document.getElementById('filter-status').value;
            const fromDate = document.getElementById('filter-date-from').value;
            const toDate = document.getElementById('filter-date-to').value;

            let filteredFiles = jobFilesCache.filter(file => {
                const searchData = [file.jfn, file.sh, file.co].join(' ').toLowerCase();
                if (searchTerm && !searchData.includes(searchTerm)) {
                    return false;
                }
                if (statusFilter && file.status !== statusFilter) {
                    return false;
                }
                if (fromDate && file.d < fromDate) {
                    return false;
                }
                if (toDate && file.d > toDate) {
                    return false;
                }
                return true;
            });

            displayJobFiles(filteredFiles);
        }

        function getFormData() {
            const getVal = id => document.getElementById(id).value || '';
            const getChecked = query => Array.from(document.querySelectorAll(query)).filter(el => el.checked).map(el => el.dataset.clearance || el.dataset.product);

            const charges = [];
            document.querySelectorAll('#charges-table-body tr:not(#total-row)').forEach(row => {
                const description = row.querySelector('.description-input').value.trim();
                const cost = row.querySelector('.cost-input').value;
                const selling = row.querySelector('.selling-input').value;

                // Only save rows that have a description and at least one value
                if (description && (cost || selling)) {
                    charges.push({
                        l: description, // 'l' for label/description
                        c: cost || '0',
                        s: selling || '0',
                        n: row.querySelector('.notes-input').value || ''
                    });
                }
            });

            return {
                d: getVal('date'), po: getVal('po-number'), jfn: getVal('job-file-no'),
                cl: getChecked('[data-clearance]:checked'), pt: getChecked('[data-product]:checked'),
                in: getVal('invoice-no'), bd: getVal('billing-date'), sm: getVal('salesman'),
                sh: getVal('shipper-name'), co: getVal('consignee-name'),
                mawb: getVal('mawb'), hawb: getVal('hawb'), ts: getVal('teams-of-shipping'), or: getVal('origin'),
                pc: getVal('no-of-pieces'), gw: getVal('gross-weight'), de: getVal('destination'), vw: getVal('volume-weight'),
                dsc: getVal('description'), ca: getVal('carrier'), tn: getVal('truck-no'),
                vn: getVal('vessel-name'), fv: getVal('flight-voyage-no'), cn: getVal('container-no'),
                ch: charges,
                re: getVal('remarks'),
                pb: getVal('prepared-by'),
            };
        }
        
        function populateFormFromData(data) {
            const setVal = (id, value) => { if (document.getElementById(id)) document.getElementById(id).value = value || ''; };
            const setChecked = (type, values) => {
                document.querySelectorAll(`[data-${type}]`).forEach(el => {
                    el.checked = (values || []).includes(el.dataset[type]);
                });
            };

            setVal('date', data.d); setVal('po-number', data.po); setVal('job-file-no', data.jfn);
            setVal('invoice-no', data.in); setVal('billing-date', data.bd);
            setVal('salesman', data.sm); setVal('shipper-name', data.sh); setVal('consignee-name', data.co);
            setVal('mawb', data.mawb); setVal('hawb', data.hawb); setVal('teams-of-shipping', data.ts);
            setVal('origin', data.or); setVal('no-of-pieces', data.pc); setVal('gross-weight', data.gw);
            setVal('destination', data.de); setVal('volume-weight', data.vw); setVal('description', data.dsc);
            setVal('carrier', data.ca); setVal('truck-no', data.tn); setVal('vessel-name', data.vn);
            setVal('flight-voyage-no', data.fv); setVal('container-no', data.cn);
            setVal('remarks', data.re); 
            
            setVal('prepared-by', data.pb || data.createdBy || '');

            const createdInfo = document.getElementById('created-by-info');
            const updatedInfo = document.getElementById('last-updated-by-info');
            
            createdInfo.textContent = data.createdBy ? `Created by: ${data.createdBy} on ${data.createdAt?.toDate().toLocaleDateString()}` : '';
            updatedInfo.textContent = data.lastUpdatedBy ? `Last updated by: ${data.lastUpdatedBy} on ${data.updatedAt?.toDate().toLocaleString()}` : '';
            
            document.getElementById('checked-stamp').style.display = 'none';
            document.getElementById('approved-stamp').style.display = 'none';
            document.getElementById('rejected-stamp').style.display = 'none';
            document.getElementById('rejection-banner').style.display = 'none';
            document.getElementById('check-btn').style.display = 'none';
            document.getElementById('approval-buttons').style.display = 'none';

            const checkBtn = document.getElementById('check-btn');
            if (data.checkedBy) {
                const checkedDate = data.checkedAt?.toDate() ? ` on ${data.checkedAt.toDate().toLocaleDateString()}` : '';
                setVal('checked-by', `${data.checkedBy}${checkedDate}`);
                checkBtn.disabled = true;
                checkBtn.textContent = 'Checked';
                document.getElementById('checked-stamp').style.display = 'block';
            } else {
                setVal('checked-by', 'Pending Check');
                checkBtn.disabled = false;
                checkBtn.textContent = 'Check Job File';
            }

            if (data.status === 'approved') {
                const approvedDate = data.approvedAt?.toDate() ? ` on ${data.approvedAt.toDate().toLocaleDateString()}` : '';
                setVal('approved-by', `${data.approvedBy}${approvedDate}`);
                document.getElementById('approved-stamp').style.display = 'block';
            } else if (data.status === 'rejected') {
                const rejectedDate = data.rejectedAt?.toDate() ? ` on ${data.rejectedAt.toDate().toLocaleDateString()}` : '';
                setVal('approved-by', `Rejected by ${data.rejectedBy}${rejectedDate}`);
                document.getElementById('rejected-stamp').style.display = 'block';
                document.getElementById('rejection-banner').style.display = 'block';
                document.getElementById('rejection-reason').textContent = data.rejectionReason;
            } else {
                setVal('approved-by', 'Pending Approval');
            }

            if (currentUser.role === 'admin') {
                if (data.status !== 'approved' && data.status !== 'rejected') {
                    document.getElementById('approval-buttons').style.display = 'flex';
                }
            }
            if (['admin', 'checker'].includes(currentUser.role)) {
                if (!data.checkedBy) {
                     document.getElementById('check-btn').style.display = 'block';
                }
            }

            setChecked('clearance', data.cl);
            setChecked('product', data.pt);

            populateTable(); // This will create the table structure
             if (data.ch && data.ch.length > 0) {
                 const tableBody = document.getElementById('charges-table-body');
                 tableBody.innerHTML = ''; // Clear empty rows
                 data.ch.forEach(charge => addChargeRow(charge));
             } else {
                // If there are no charges, ensure there are some empty rows to start with
                for(let i=0; i<5; i++) addChargeRow();
            }
            calculate();
        }
        
        function createPrintWindow(title, content) {
            let styles = '';
            document.querySelectorAll('style, link[rel="stylesheet"]').forEach(el => {
                styles += el.outerHTML;
            });

            const printWindow = window.open('', '', 'height=800,width=1200');
            
            printWindow.document.write(`<html><head><title>${title}</title>`);
            printWindow.document.write(styles);
            printWindow.document.write(content);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            
            setTimeout(() => {
                printWindow.focus();
                printWindow.print();
                printWindow.close();
            }, 750);
        }

        function printAnalytics() {
            const analyticsBody = document.getElementById('analytics-body').innerHTML;
            const printContent = `
                <style>
                    body { padding: 1.5rem; background-color: white !important; }
                    #sort-analytics, button, select, .analytics-table td:last-child, .analytics-table th:last-child { display: none !important; }
                    .modal-content { box-shadow: none; border: none; }
                </style>
                </head><body>
                <h1 class="text-3xl font-bold mb-6 text-center">Analytics Report</h1>
                ${analyticsBody}
            `;
            createPrintWindow('Analytics Report', printContent);
        }

        function printPreview() {
            const previewBody = document.getElementById('preview-body').innerHTML;
            const printContent = `
                <style>
                    body { padding: 0; margin: 0; background-color: white !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                    .no-print { display: none !important; }
                </style>
                </head><body>
                ${previewBody}
            `;
            createPrintWindow('Job File Preview', printContent);
        }

        function getPrintViewHtml(data, isPublicView = false) {
            const totalCost = data.totalCost || 0;
            const totalSelling = data.totalSelling || 0;
            const totalProfit = data.totalProfit || 0;
            
            const checkedByText = data.checkedBy ? `${data.checkedBy} on ${data.checkedAt?.toDate().toLocaleDateString()}` : 'Pending';
            let approvedByText = 'Pending Approval';
            if (data.status === 'approved') {
                approvedByText = `${data.approvedBy} on ${data.approvedAt?.toDate().toLocaleDateString()}`;
            } else if (data.status === 'rejected') {
                approvedByText = `REJECTED: ${data.rejectionReason}`;
            }
            
            const createdByText = data.createdBy ? `${data.createdBy} on ${data.createdAt?.toDate().toLocaleDateString()}` : (data.pb || 'N/A');
            
            const checkedStampHtml = data.checkedBy ? `<div class="stamp stamp-checked" style="display: block;">Checked</div>` : '';
            let approvalStampHtml = '';
            if (data.status === 'approved') {
                approvalStampHtml = `<div class="stamp stamp-approved" style="display: block;">Approved</div>`;
            } else if (data.status === 'rejected') {
                approvalStampHtml = `<div class="stamp stamp-rejected" style="display: block;">Rejected</div>`;
            }

            const checkedSymbol = '‚òë';
            const uncheckedSymbol = '‚òê';
            
            const qrContainerHtml = isPublicView ? '' : `<div class="col-span-3 bg-white p-1 flex items-center justify-center" style="border: 1px solid #374151;"><div class="qrcode-container"></div></div>`;

            const descriptionHtml = `<div class="col-span-12 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>Description:</strong><div class="print-field">${data.dsc || ''}</div></div>`;

            return `
                <div class="border border-gray-700 p-2 bg-white">
                    <div class="grid grid-cols-12 gap-px bg-gray-700" style="border: 1px solid #374151;">
                        <div class="col-span-3 bg-white p-1 flex items-center" style="border: 1px solid #374151;">
                             <img src="http://qgocargo.com/logo.png" alt="Q'go Cargo Logo" class="h-16 w-auto">
                        </div>
                        <div class="col-span-6 bg-white flex items-center justify-center text-xl font-bold" style="border: 1px solid #374151;">JOB FILE</div>
                        <div class="col-span-3 bg-white p-1 text-xs" style="border: 1px solid #374151;"><div><strong>Date:</strong> ${data.d || ''}</div><div><strong>P.O. #:</strong> ${data.po || ''}</div></div>
                        
                        <div class="col-span-12 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>Job File No.:</strong> ${data.jfn || ''}</div>

                        <div class="col-span-12 bg-white p-1 grid grid-cols-2 sm:grid-cols-4 gap-2 text-xs" style="border: 1px solid #374151;">
                            <div><strong>Clearance</strong><br>${(data.cl || []).includes('Export') ? checkedSymbol : uncheckedSymbol} Export<br>${(data.cl || []).includes('Import') ? checkedSymbol : uncheckedSymbol} Import<br>${(data.cl || []).includes('Clearance') ? checkedSymbol : uncheckedSymbol} Clearance<br>${(data.cl || []).includes('Local Move') ? checkedSymbol : uncheckedSymbol} Local Move</div>
                            <div><strong>Product Type</strong><br>${(data.pt || []).includes('Air Freight') ? checkedSymbol : uncheckedSymbol} Air<br>${(data.pt || []).includes('Sea Freight') ? checkedSymbol : uncheckedSymbol} Sea<br>${(data.pt || []).includes('Land Freight') ? checkedSymbol : uncheckedSymbol} Land<br>${(data.pt || []).includes('Others') ? checkedSymbol : uncheckedSymbol} Others</div>
                        </div>

                        <div class="col-span-6 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>Invoice No.:</strong><div class="print-field">${data.in || ''}</div></div>
                        <div class="col-span-6 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>Billing Date:</strong><div class="print-field">${data.bd || ''}</div></div>
                        <div class="col-span-12 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>Salesman:</strong><div class="print-field">${data.sm || ''}</div></div>

                        <div class="col-span-6 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>Shipper's Name:</strong><div class="print-field">${data.sh || ''}</div></div>
                        <div class="col-span-6 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>Consignee's Name:</strong><div class="print-field">${data.co || ''}</div></div>
                        
                        <div class="col-span-6 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>MAWB/OBL/TCN:</strong><div class="print-field">${data.mawb || ''}</div></div>
                        <div class="col-span-6 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>Teams of Shipping:</strong><div class="print-field">${data.ts || ''}</div></div>
                        <div class="col-span-6 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>HAWB/HBL:</strong><div class="print-field">${data.hawb || ''}</div></div>
                        <div class="col-span-3 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>Origin:</strong><div class="print-field">${data.or || ''}</div></div>
                        <div class="col-span-3 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>Destination:</strong><div class="print-field">${data.de || ''}</div></div>
                        <div class="col-span-3 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>No. of Pieces:</strong><div class="print-field">${data.pc || ''}</div></div>
                        <div class="col-span-3 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>Gross Wt:</strong><div class="print-field">${data.gw || ''}</div></div>
                        <div class="col-span-6 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>Volume Wt:</strong><div class="print-field">${data.vw || ''}</div></div>
                        
                        ${descriptionHtml}
                        <div class="col-span-6 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>Carrier/Line/Trucking:</strong><div class="print-field">${data.ca || ''}</div></div>
                        <div class="col-span-6 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>Truck/Driver:</strong><div class="print-field">${data.tn || ''}</div></div>
                        <div class="col-span-4 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>Vessel:</strong><div class="print-field">${data.vn || ''}</div></div>
                        <div class="col-span-4 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>Flight/Voyage:</strong><div class="print-field">${data.fv || ''}</div></div>
                        <div class="col-span-4 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>Container No:</strong><div class="print-field">${data.cn || ''}</div></div>

                        <div class="col-span-12 bg-white p-0" style="border: 1px solid #374151;">
                            <table class="print-table w-full text-xs">
                                <thead><tr><th>Description</th><th>Cost</th><th>Selling</th><th>Profit</th><th>Notes</th></tr></thead>
                                <tbody>
                                    ${(data.ch || []).map(c => `<tr><td>${c.l}</td><td>${c.c}</td><td>${c.s}</td><td>${(parseFloat(c.s || 0) - parseFloat(c.c || 0)).toFixed(3)}</td><td>${c.n}</td></tr>`).join('')}
                                    <tr class="font-bold bg-gray-100"><td>TOTAL:</td><td>${totalCost.toFixed(3)}</td><td>${totalSelling.toFixed(3)}</td><td>${totalProfit.toFixed(3)}</td><td></td></tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="col-span-12 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>REMARKS:</strong><div class="print-field h-20">${(data.re || '').replace(/\n/g, '<br>')}</div></div>
                        <div class="col-span-3 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>PREPARED BY:</strong><div class="print-field">${createdByText}</div></div>
                        <div class="col-span-3 bg-white p-1 text-xs relative" style="border: 1px solid #374151;">${checkedStampHtml}<strong>CHECKED BY:</strong><div class="print-field">${checkedByText}</div></div>
                        <div class="col-span-3 bg-white p-1 text-xs relative" style="border: 1px solid #374151;">${approvalStampHtml}<strong>APPROVED BY:</strong><div class="print-field">${approvedByText}</div></div>
                        ${qrContainerHtml}
                    </div>
                </div>`;
        }

        function printPage() {
            const data = getFormData();
            const printHTML = getPrintViewHtml(data, false);
            const printContainer = document.getElementById('print-output');
            printContainer.innerHTML = printHTML;

            const qrContainer = printContainer.querySelector('.qrcode-container');
            if (qrContainer && data.jfn) {
                qrContainer.innerHTML = '';
                const baseUrl = window.location.href.split('?')[0];
                const qrText = `${baseUrl}?jobId=${encodeURIComponent(data.jfn)}`;
                new QRCode(qrContainer, {
                    text: qrText,
                    width: 96,
                    height: 96,
                    correctLevel: QRCode.CorrectLevel.H
                });
            }

            document.getElementById('main-container').style.display = 'none';
            printContainer.style.display = 'block';
            
            setTimeout(() => { window.print(); }, 500);
        }

        function calculate() {
            let totalCost = 0, totalSelling = 0, totalProfit = 0;
            document.querySelectorAll('#charges-table-body tr:not(#total-row)').forEach(row => {
                const cost = parseFloat(row.querySelector('.cost-input').value) || 0;
                const selling = parseFloat(row.querySelector('.selling-input').value) || 0;
                const profit = selling - cost;
                row.cells[3].textContent = profit.toFixed(3);
                totalCost += cost; totalSelling += selling; totalProfit += profit;
            });
            document.getElementById('total-cost').textContent = totalCost.toFixed(3);
            document.getElementById('total-selling').textContent = totalSelling.toFixed(3);
            document.getElementById('total-profit').textContent = totalProfit.toFixed(3);
        }
        
        function populateTable() {
            const table = document.getElementById('charges-table');
            table.innerHTML = `
                <thead>
                    <tr class="bg-gray-100">
                        <th class="table-cell font-semibold w-2/5">Description</th>
                        <th class="table-cell font-semibold">Cost</th>
                        <th class="table-cell font-semibold">Selling</th>
                        <th class="table-cell font-semibold">Profit</th>
                        <th class="table-cell font-semibold">Notes</th>
                         <th class="table-cell font-semibold"></th>
                    </tr>
                </thead>
                <tbody id="charges-table-body">
                </tbody>
                <tfoot>
                     <tr id="total-row" class="bg-gray-100 font-bold">
                        <td class="table-cell text-right">TOTAL:</td>
                        <td id="total-cost" class="table-cell text-right">0.000</td>
                        <td id="total-selling" class="table-cell text-right">0.000</td>
                        <td id="total-profit" class="table-cell text-right">0.000</td>
                        <td class="table-cell" colspan="2"></td>
                    </tr>
                </tfoot>
            `;

            const tableBody = document.getElementById('charges-table-body');
            tableBody.addEventListener('input', e => {
                if (e.target.classList.contains('cost-input') || e.target.classList.contains('selling-input')) {
                    calculate();
                }
            });
             for(let i=0; i<5; i++) addChargeRow();
        }

        function addChargeRow(data = {}) {
            const tableBody = document.getElementById('charges-table-body');
            const newRow = document.createElement('tr');

            newRow.innerHTML = `
                <td class="table-cell"><input type="text" class="description-input input-field" value="${data.l || ''}" autocomplete="off"></td>
                <td class="table-cell"><input type="number" step="0.001" class="cost-input input-field" value="${data.c || ''}"></td>
                <td class="table-cell"><input type="number" step="0.001" class="selling-input input-field" value="${data.s || ''}"></td>
                <td class="table-cell profit-output bg-gray-50 text-right">${((data.s || 0) - (data.c || 0)).toFixed(3)}</td>
                <td class="table-cell"><input type="text" class="notes-input input-field" value="${data.n || ''}"></td>
                <td class="table-cell text-center"><button class="text-red-500 hover:text-red-700">&times;</button></td>
            `;

            const descriptionInput = newRow.querySelector('.description-input');
            setupChargeAutocomplete(descriptionInput);
            
            const deleteButton = newRow.querySelector('button');
            deleteButton.addEventListener('click', () => {
                newRow.remove();
                calculate();
            });

            tableBody.appendChild(newRow);
        }
        
        function toggleAuthView(showLogin) {
            const nameField = document.getElementById('signup-name-field');
            const emailField = document.getElementById('email-address');
            
            document.getElementById('auth-title').textContent = showLogin ? 'Sign in to your account' : 'Create a new account';
            document.getElementById('auth-btn').textContent = showLogin ? 'Sign in' : 'Sign up';
            document.getElementById('auth-link').textContent = showLogin ? 'Create a new account' : 'Already have an account? Sign in';
            nameField.style.display = showLogin ? 'none' : 'block';
            emailField.classList.toggle('rounded-t-md', !showLogin);
            document.getElementById('approval-message').style.display = 'none';
        }

        function updateStatusSummary(targetId, dataSource) {
            const approvedCount = dataSource.filter(file => file.status === 'approved').length;
            const rejectedCount = dataSource.filter(file => file.status === 'rejected').length;
            const checkedCount = dataSource.filter(file => file.status === 'checked').length;
            const pendingCount = dataSource.filter(file => file.status === 'pending' || !file.status).length;

            const summaryHtml = `
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 text-center">
                    <div onclick="showStatusJobs('approved')" class="bg-green-100 p-4 rounded-lg cursor-pointer shadow-md hover:shadow-lg hover:-translate-y-1 transition-all duration-300"><p class="text-sm text-green-800">Approved</p><p class="text-2xl font-bold text-green-900">${approvedCount}</p></div>
                    <div onclick="showStatusJobs('rejected')" class="bg-red-100 p-4 rounded-lg cursor-pointer shadow-md hover:shadow-lg hover:-translate-y-1 transition-all duration-300"><p class="text-sm text-red-800">Rejected</p><p class="text-2xl font-bold text-red-900">${rejectedCount}</p></div>
                    <div onclick="showStatusJobs('checked')" class="bg-blue-100 p-4 rounded-lg cursor-pointer shadow-md hover:shadow-lg hover:-translate-y-1 transition-all duration-300"><p class="text-sm text-blue-800">Checked</p><p class="text-2xl font-bold text-blue-900">${checkedCount}</p></div>
                    <div onclick="showStatusJobs('pending')" class="bg-yellow-100 p-4 rounded-lg cursor-pointer shadow-md hover:shadow-lg hover:-translate-y-1 transition-all duration-300"><p class="text-sm text-yellow-800">Pending</p><p class="text-2xl font-bold text-yellow-900">${pendingCount}</p></div>
                </div>
            `;
            document.getElementById(targetId).innerHTML = summaryHtml;
        }

        // --- GEMINI API INTEGRATION ---

        async function callGeminiApi(payload, retries = 3, delay = 1000) {
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    if (response.status === 429 && retries > 0) {
                        console.warn(`API call failed with status 429. Retrying in ${delay}ms...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        return callGeminiApi(payload, retries - 1, delay * 2);
                    }
                    throw new Error(`API call failed with status ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                if (retries > 0) {
                    console.warn(`API call failed. Retrying in ${delay}ms...`, error);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return callGeminiApi(payload, retries - 1, delay * 2);
                }
                console.error("API call failed after multiple retries:", error);
                throw error;
            }
        }

        async function generateRemarks() {
            showLoader();
            try {
                const data = getFormData();
                const prompt = `
                    Generate professional remarks for a freight forwarding job file with the following details.
                    The remarks should be concise and summarize the key aspects of the shipment.

                    - Product Type: ${(data.pt || []).join(', ') || 'Not specified'}
                    - Clearance Type: ${(data.cl || []).join(', ') || 'Not specified'}
                    - Shipper: ${data.sh || 'Not specified'}
                    - Consignee: ${data.co || 'Not specified'}
                    - Origin: ${data.or || 'Not specified'}
                    - Destination: ${data.de || 'Not specified'}
                    - Description of Goods: ${data.dsc || 'Not specified'}
                    - Carrier: ${data.ca || 'Not specified'}
                    - MAWB/OBL: ${data.mawb || 'Not specified'}

                    Generate a short paragraph suitable for the remarks section.
                `;

                const payload = {
                    contents: [{ role: "user", parts: [{ text: prompt }] }]
                };

                const result = await callGeminiApi(payload);
                
                if (result.candidates && result.candidates[0]?.content?.parts?.[0]) {
                    const text = result.candidates[0].content.parts[0].text;
                    document.getElementById('remarks').value = text;
                    showNotification("Remarks generated successfully! ‚ú®");
                } else {
                    throw new Error("Invalid response structure from Gemini API.");
                }

            } catch (error) {
                console.error("Error generating remarks:", error);
                showNotification("Could not generate remarks. Please try again.", true);
            } finally {
                hideLoader();
            }
        }

        async function suggestCharges() {
            showLoader();
            try {
                const data = getFormData();
                
                const prompt = `
                    Based on the following freight forwarding job details, suggest typical cost and selling prices in Kuwaiti Dinar (KD) for relevant charges.
                    Provide reasonable, non-zero estimates for relevant charges. Only include charges that are applicable.
                    
                    - Product Type: ${(data.pt || []).join(', ') || 'General'}
                    - Clearance Type: ${(data.cl || []).join(', ') || 'Standard'}
                    - Origin: ${data.or || 'Unknown'}
                    - Destination: ${data.de || 'Unknown'}
                    - Description of Goods: ${data.dsc || 'General Goods'}
                    - Gross Weight: ${data.gw || 'N/A'}
                    - Predefined Charges: ${chargeDescriptions.join(', ')}

                    Which of the predefined charges are most relevant and what are their estimated costs and selling prices?
                `;

                const payload = {
                    contents: [{ role: "user", parts: [{ text: prompt }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                charges: {
                                    type: "ARRAY",
                                    items: {
                                        type: "OBJECT",
                                        properties: {
                                            chargeName: { type: "STRING" },
                                            cost: { type: "NUMBER" },
                                            selling: { type: "NUMBER" }
                                        },
                                        required: ["chargeName", "cost", "selling"]
                                    }
                                }
                            }
                        }
                    }
                };

                const result = await callGeminiApi(payload);

                if (result.candidates && result.candidates[0]?.content?.parts?.[0]) {
                    
                    const jsonText = result.candidates[0].content.parts[0].text;
                    const parsedJson = JSON.parse(jsonText);
                    
                    if (parsedJson.charges && Array.isArray(parsedJson.charges)) {
                        const tableBody = document.getElementById('charges-table-body');
                        tableBody.innerHTML = '';
                        if(parsedJson.charges.length === 0){
                             for(let i=0; i<5; i++) addChargeRow();
                        } else {
                            parsedJson.charges.forEach(charge => {
                                addChargeRow({
                                    l: charge.chargeName,
                                    c: charge.cost || 0,
                                    s: charge.selling || 0,
                                    n: ''
                                });
                            });
                        }
                        
                        calculate();
                        showNotification("Charges suggested successfully! ‚ú®");
                    } else {
                         throw new Error("Invalid JSON structure in API response.");
                    }
                } else {
                    throw new Error("Invalid response structure from Gemini API.");
                }

            } catch (error) {
                console.error("Error suggesting charges:", error);
                showNotification("Could not suggest charges. Please try again.", true);
            } finally {
                hideLoader();
            }
        }
        
        // --- Client Management Functions ---
        function openClientManager() { openModal('client-manager-modal'); }

        function loadClients() {
            if (!db) return;
            const clientsCollection = collection(db, 'clients');
            onSnapshot(query(clientsCollection), (snapshot) => {
                clientsCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                clientsCache.sort((a, b) => a.name.localeCompare(b.name)); // Sort alphabetically
                displayClients(clientsCache);
            }, (error) => {
                console.error("Error loading clients:", error);
                showNotification("Could not load clients.", true);
            });
        }

        function displayClients(clients) {
            const list = document.getElementById('client-list');
            if (clients.length === 0) {
                list.innerHTML = `<p class="text-gray-500 text-center p-4">No clients found.</p>`;
                return;
            }
            list.innerHTML = clients.map(client => `
                <div class="client-item border p-3 rounded-lg bg-gray-50 hover:bg-gray-100" data-search-term="${client.name.toLowerCase()}">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-bold">${client.name}</p>
                            <p class="text-sm text-gray-600">${client.address || ''}</p>
                            <p class="text-xs text-gray-500">${client.contactPerson || ''} - ${client.phone || ''}</p>
                        </div>
                        <div class="flex-shrink-0 space-x-2">
                            <button onclick="editClient('${client.id}')" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-1 px-2 rounded text-xs">Edit</button>
                            <button onclick="confirmDelete('${client.id}', 'client')" class="bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-2 rounded text-xs">Delete</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function saveClient(event) {
            event.preventDefault();
            const clientId = document.getElementById('client-id').value;
            const clientName = document.getElementById('client-name').value.trim();

            if (!clientName) {
                showNotification("Client name is required.", true);
                return;
            }

            const clientData = {
                name: clientName,
                address: document.getElementById('client-address').value.trim(),
                contactPerson: document.getElementById('client-contact-person').value.trim(),
                phone: document.getElementById('client-phone').value.trim(),
                type: document.getElementById('client-type').value,
                updatedAt: serverTimestamp()
            };

            showLoader();
            try {
                let docRef;
                if (clientId) {
                    // Update existing client
                    docRef = doc(db, 'clients', clientId);
                    await setDoc(docRef, clientData, { merge: true });
                    showNotification("Client updated successfully!");
                } else {
                    // Add new client
                    clientData.createdAt = serverTimestamp();
                    const clientsCollection = collection(db, 'clients');
                    docRef = await addDoc(clientsCollection, clientData);
                    showNotification("Client added successfully!");
                }
                clearClientForm();
            } catch (error) {
                console.error("Error saving client:", error);
                showNotification("Could not save client.", true);
            } finally {
                hideLoader();
            }
        }
        
        function clearClientForm() {
            document.getElementById('client-form').reset();
            document.getElementById('client-id').value = '';
            document.getElementById('client-form-title').textContent = 'Add New Client';
        }

        function editClient(clientId) {
            const client = clientsCache.find(c => c.id === clientId);
            if (client) {
                document.getElementById('client-id').value = client.id;
                document.getElementById('client-name').value = client.name;
                document.getElementById('client-address').value = client.address || '';
                document.getElementById('client-contact-person').value = client.contactPerson || '';
                document.getElementById('client-phone').value = client.phone || '';
                document.getElementById('client-type').value = client.type || 'Shipper';
                document.getElementById('client-form-title').textContent = 'Edit Client';
            }
        };

        async function deleteClient(clientId) {
            showLoader();
            try {
                await deleteDoc(doc(db, 'clients', clientId));
                showNotification("Client deleted successfully.");
            } catch (error) {
                console.error("Error deleting client:", error);
                showNotification("Could not delete client.", true);
            } finally {
                hideLoader();
            }
        }

        function setupAutocomplete(inputId, suggestionsId, type) {
            const input = document.getElementById(inputId);
            const suggestionsPanel = document.getElementById(suggestionsId);
            let activeSuggestionIndex = -1;

            const updateSelection = (suggestions) => {
                suggestions.forEach((suggestion, index) => {
                    if (index === activeSuggestionIndex) {
                        suggestion.classList.add('selected');
                        suggestion.scrollIntoView({ block: 'nearest' });
                    } else {
                        suggestion.classList.remove('selected');
                    }
                });
            };

            input.addEventListener('input', () => {
                const value = input.value.toLowerCase();
                if (value.length < 2) {
                    suggestionsPanel.innerHTML = '';
                    suggestionsPanel.classList.add('hidden');
                    return;
                }

                const filteredClients = clientsCache.filter(client => 
                    client.name.toLowerCase().includes(value) && 
                    (client.type === type || client.type === 'Both')
                );

                if (filteredClients.length > 0) {
                    suggestionsPanel.innerHTML = filteredClients.map(client => 
                        `<div class="autocomplete-suggestion" data-name="${client.name}">${client.name}</div>`
                    ).join('');
                    suggestionsPanel.classList.remove('hidden');
                    activeSuggestionIndex = -1;
                } else {
                    suggestionsPanel.innerHTML = '';
                    suggestionsPanel.classList.add('hidden');
                }
            });

            input.addEventListener('keydown', (e) => {
                const suggestions = suggestionsPanel.querySelectorAll('.autocomplete-suggestion');
                if (suggestionsPanel.classList.contains('hidden') || suggestions.length === 0) return;

                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    activeSuggestionIndex++;
                    if (activeSuggestionIndex >= suggestions.length) activeSuggestionIndex = 0;
                    updateSelection(suggestions);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    activeSuggestionIndex--;
                    if (activeSuggestionIndex < 0) activeSuggestionIndex = suggestions.length - 1;
                    updateSelection(suggestions);
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (activeSuggestionIndex > -1) {
                        suggestions[activeSuggestionIndex].click();
                    }
                } else if (e.key === 'Escape') {
                    suggestionsPanel.classList.add('hidden');
                }
            });

            suggestionsPanel.addEventListener('click', (e) => {
                if (e.target.classList.contains('autocomplete-suggestion')) {
                    input.value = e.target.dataset.name;
                    suggestionsPanel.innerHTML = '';
                    suggestionsPanel.classList.add('hidden');
                    activeSuggestionIndex = -1;
                }
            });

            document.addEventListener('click', (e) => {
                if (e.target.id !== inputId) {
                    suggestionsPanel.classList.add('hidden');
                }
            });
        }


        function refreshOpenModals() {
            if (document.getElementById('user-jobs-modal').classList.contains('visible')) {
                const title = document.getElementById('user-jobs-modal-title').textContent;
                if(title.includes('Created by')) {
                    const userName = title.replace('Job Files Created by ', '');
                    showUserJobs(userName);
                } else if (title.includes('Salesman')) {
                     const salesmanName = title.replace('Job Files for Salesman: ', '');
                     showSalesmanJobs(salesmanName);
                } else if (title.includes('for')) {
                    const month = title.replace('Job Files for ', '');
                    // We need to know the date type to refresh properly
                    const dateType = document.getElementById('analytics-date-type')?.value || 'bd';
                    showMonthlyJobs(month, dateType);
                } else if (title.includes(' - ')) {
                    const status = title.split(' - ')[1].toLowerCase();
                    showStatusJobs(status);
                }
            }
        }
        
        function showSalesmanJobs(salesmanName) {
            const salesmanJobs = currentFilteredJobs.filter(job => (job.sm || 'N/A') === salesmanName);
            displayJobsInModal(salesmanJobs, `Job Files for Salesman: ${salesmanName}`);
        }

        function showUserJobs(userName) {
            const userJobs = currentFilteredJobs.filter(job => job.createdBy === userName);
            displayJobsInModal(userJobs, `Job Files Created by ${userName}`);
        }
        
        function showMonthlyJobs(month, dateType) {
            const monthlyJobs = currentFilteredJobs.filter(job => {
                const dateField = dateType === 'billing' ? job.bd : job.d;
                return dateField && dateField.startsWith(month);
            });
            displayJobsInModal(monthlyJobs, `Job Files for ${month}`);
        }

        function showStatusJobs(status) {
            const statusJobs = jobFilesCache.filter(job => {
                if (status === 'pending') {
                    return job.status === 'pending' || !job.status;
                }
                return job.status === status;
            });
            displayJobsInModal(statusJobs, `Job Files - ${status.charAt(0).toUpperCase() + status.slice(1)}`);
        }

        function displayJobsInModal(jobs, title) {
            const modalTitle = document.getElementById('user-jobs-modal-title');
            const list = document.getElementById('user-jobs-list');

            modalTitle.textContent = title;

            if (jobs.length === 0) {
                list.innerHTML = `<p class="text-gray-500 text-center p-4">No job files found.</p>`;
            } else {
                 let filesHtml = '';
                 jobs.forEach((docData) => {
                     const deleteButton = currentUser.role === 'admin' ? `<button onclick="confirmDelete('${docData.id}')" class="bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-2 rounded text-xs">Delete</button>` : '';
                     
                     let checkOrUncheckButton = '';
                     if (currentUser.role === 'admin' || currentUser.role === 'checker') {
                         if (docData.status === 'checked' || docData.status === 'approved') {
                             checkOrUncheckButton = `<button onclick="uncheckJobFile('${docData.id}')" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-1 px-2 rounded text-xs">Uncheck</button>`;
                         } else if (docData.status === 'pending' || !docData.status) {
                             checkOrUncheckButton = `<button onclick="checkJobFile('${docData.id}')" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-1 px-2 rounded text-xs">Check</button>`;
                         }
                     }

                     let approveButton = '';
                     let rejectButton = '';
                     if (currentUser.role === 'admin' && docData.status === 'checked') {
                         approveButton = `<button onclick="approveJobFile('${docData.id}')" class="bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-2 rounded text-xs">Approve</button>`;
                         rejectButton = `<button onclick="promptForRejection('${docData.id}')" class="bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-2 rounded text-xs">Reject</button>`;
                     }
                     
                     filesHtml += `
                         <div class="job-file-item border p-3 rounded-lg flex flex-col sm:flex-row justify-between items-center bg-gray-50 hover:bg-gray-100 gap-2">
                             <div class="w-full sm:w-2/5">
                                 <p class="font-bold text-indigo-700">${docData.jfn || 'No ID'}</p>
                                 <p class="text-sm text-gray-600">Shipper: ${docData.sh || 'N/A'}</p>
                                 <p class="text-sm text-gray-600">Consignee: ${docData.co || 'N/A'}</p>
                             </div>
                             <div class="w-full sm:w-1/5 text-xs text-gray-500">
                                 <p>Cost: <span class="font-medium text-red-600">KD ${(docData.totalCost || 0).toFixed(3)}</span></p>
                                 <p>Profit: <span class="font-medium text-green-600">KD ${(docData.totalProfit || 0).toFixed(3)}</span></p>
                             </div>
                             <div class="space-x-2 flex-shrink-0">
                                 <button onclick="previewJobFileById('${docData.id}')" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-1 px-2 rounded text-xs">Preview</button>
                                 <button onclick="loadJobFileById('${docData.id}')" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-1 px-2 rounded text-xs">Load</button>
                                 ${checkOrUncheckButton}
                                 ${approveButton}
                                 ${rejectButton}
                                 ${deleteButton}
                             </div>
                         </div>
                     `;
                 });
                 list.innerHTML = filesHtml;
            }
            openModal('user-jobs-modal', true);
        }

        // --- Recycle Bin Functions ---
        async function openRecycleBin() {
            showLoader();
            try {
                const deletedFilesRef = collection(db, 'deleted_jobfiles');
                const q = query(deletedFilesRef);
                const querySnapshot = await getDocs(q);
                const deletedFiles = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                const list = document.getElementById('recycle-bin-list');
                if (deletedFiles.length === 0) {
                    list.innerHTML = `<p class="text-gray-500 text-center p-4">The recycle bin is empty.</p>`;
                } else {
                    let filesHtml = '';
                    deletedFiles.forEach((docData) => {
                        const deletedAt = docData.deletedAt?.toDate ? docData.deletedAt.toDate().toLocaleString() : 'N/A';
                        filesHtml += `
                            <div class="job-file-item border p-3 rounded-lg flex flex-col sm:flex-row justify-between items-center bg-gray-50 hover:bg-gray-100 gap-2">
                                <div class="text-center sm:text-left">
                                    <p class="font-bold text-indigo-700">${docData.jfn || 'No ID'}</p>
                                    <p class="text-sm text-gray-600">Shipper: ${docData.sh || 'N/A'}</p>
                                    <p class="text-xs text-gray-400">Deleted by ${docData.deletedBy || 'Unknown'} on ${deletedAt}</p>
                                </div>
                                <div class="space-x-2 flex-shrink-0">
                                    <button onclick="restoreJobFile('${docData.id}')" class="bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-3 rounded text-sm">Restore</button>
                                    <button onclick="confirmPermanentDelete('${docData.id}')" class="bg-red-700 hover:bg-red-800 text-white font-bold py-1 px-3 rounded text-sm">Delete Permanently</button>
                                </div>
                            </div>
                        `;
                    });
                    list.innerHTML = filesHtml;
                }
                openModal('recycle-bin-modal', true);
            } catch (error) {
                console.error("Error opening recycle bin:", error);
                showNotification("Could not open recycle bin.", true);
            } finally {
                hideLoader();
            }
        }

        async function restoreJobFile(docId) {
            showLoader();
            try {
                const deletedDocRef = doc(db, 'deleted_jobfiles', docId);
                const docSnap = await getDoc(deletedDocRef);

                if (docSnap.exists()) {
                    const dataToRestore = docSnap.data();
                    delete dataToRestore.deletedAt;
                    delete dataToRestore.deletedBy;

                    const newDocRef = doc(db, 'jobfiles', docId);
                    await setDoc(newDocRef, dataToRestore);
                    await deleteDoc(deletedDocRef);

                    showNotification("Job file restored successfully.");
                    openRecycleBin(); // Refresh the recycle bin view
                } else {
                    throw new Error("Document not found in recycle bin.");
                }
            } catch (error) {
                console.error("Error restoring file:", error);
                showNotification("Error restoring file.", true);
            } finally {
                hideLoader();
            }
        }

        function confirmPermanentDelete(docId) {
            const modal = document.getElementById('confirm-modal');
            modal.querySelector('#confirm-title').textContent = 'Confirm Permanent Deletion';
            modal.querySelector('#confirm-message').innerHTML = `Are you sure you want to permanently delete job file "${docId.replace(/_/g, '/')}"? <b class="text-red-600">This action cannot be undone.</b>`;
            modal.querySelector('#confirm-ok').className = 'bg-red-700 hover:bg-red-800 text-white font-bold py-2 px-4 rounded';
            openModal('confirm-modal', true);

            const okButton = modal.querySelector('#confirm-ok');
            const cancelButton = modal.querySelector('#confirm-cancel');

            const onOk = () => {
                permanentlyDeleteJobFile(docId);
                closeConfirm();
            };

            const closeConfirm = () => {
                closeModal('confirm-modal');
                okButton.removeEventListener('click', onOk);
            };

            okButton.addEventListener('click', onOk, { once: true });
            cancelButton.addEventListener('click', closeConfirm, { once: true });
        }

        async function permanentlyDeleteJobFile(docId) {
            showLoader();
            try {
                const deletedDocRef = doc(db, 'deleted_jobfiles', docId);
                await deleteDoc(deletedDocRef);
                showNotification("Job file permanently deleted.");
                openRecycleBin(); // Refresh the recycle bin view
            } catch (error) {
                console.error("Error permanently deleting file:", error);
                showNotification("Could not permanently delete file.", true);
            } finally {
                hideLoader();
            }
        }

        function openChargeManager() {
            displayChargeDescriptions();
            openModal('charge-manager-modal');
        }

        function displayChargeDescriptions() {
            const list = document.getElementById('charge-description-list');
            list.innerHTML = chargeDescriptions.map(desc => `
                <div class="flex justify-between items-center p-2 bg-gray-100 rounded">
                    <span>${desc}</span>
                    <button onclick="deleteChargeDescription('${desc}')" class="text-red-500 hover:text-red-700">&times;</button>
                </div>
            `).join('');
        }

        function saveChargeDescription() {
            const input = document.getElementById('new-charge-description');
            const newDesc = input.value.trim();
            if (newDesc && !chargeDescriptions.includes(newDesc)) {
                chargeDescriptions.push(newDesc);
                localStorage.setItem('chargeDescriptions', JSON.stringify(chargeDescriptions));
                displayChargeDescriptions();
                input.value = '';
            }
        }

        function deleteChargeDescription(description) {
            chargeDescriptions = chargeDescriptions.filter(d => d !== description);
            localStorage.setItem('chargeDescriptions', JSON.stringify(chargeDescriptions));
            displayChargeDescriptions();
        }
        
        function setupChargeAutocomplete(inputElement) {
            let suggestionsPanel = inputElement.parentElement.querySelector('.autocomplete-suggestions');
            if (!suggestionsPanel) {
                suggestionsPanel = document.createElement('div');
                suggestionsPanel.className = 'autocomplete-suggestions hidden';
                inputElement.parentElement.appendChild(suggestionsPanel);
            }
            let activeSuggestionIndex = -1;

            const updateSelection = (suggestions) => {
                suggestions.forEach((suggestion, index) => {
                    if (index === activeSuggestionIndex) {
                        suggestion.classList.add('selected');
                        suggestion.scrollIntoView({ block: 'nearest' });
                    } else {
                        suggestion.classList.remove('selected');
                    }
                });
            };

            const showSuggestions = () => {
                 const value = inputElement.value.toLowerCase();
                if (!value) {
                    suggestionsPanel.classList.add('hidden');
                    return;
                }
                const filtered = chargeDescriptions.filter(d => d.toLowerCase().includes(value));
                if (filtered.length > 0) {
                    suggestionsPanel.innerHTML = filtered.map(d => `<div class="autocomplete-suggestion">${d}</div>`).join('');
                    suggestionsPanel.classList.remove('hidden');
                } else {
                    suggestionsPanel.classList.add('hidden');
                }
                activeSuggestionIndex = -1;
            };

            inputElement.addEventListener('input', showSuggestions);

            inputElement.addEventListener('keydown', (e) => {
                const suggestions = suggestionsPanel.querySelectorAll('.autocomplete-suggestion');
                if (suggestionsPanel.classList.contains('hidden') || suggestions.length === 0) return;

                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    activeSuggestionIndex++;
                    if (activeSuggestionIndex >= suggestions.length) activeSuggestionIndex = 0;
                    updateSelection(suggestions);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    activeSuggestionIndex--;
                    if (activeSuggestionIndex < 0) activeSuggestionIndex = suggestions.length - 1;
                    updateSelection(suggestions);
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (activeSuggestionIndex > -1) {
                        suggestions[activeSuggestionIndex].click();
                    }
                } else if (e.key === 'Escape') {
                    suggestionsPanel.classList.add('hidden');
                }
            });

            suggestionsPanel.addEventListener('click', (e) => {
                if (e.target.classList.contains('autocomplete-suggestion')) {
                    inputElement.value = e.target.textContent;
                    suggestionsPanel.classList.add('hidden');
                    activeSuggestionIndex = -1;
                }
            });
            
            inputElement.addEventListener('blur', () => {
                setTimeout(() => suggestionsPanel.classList.add('hidden'), 150);
            });
        }


        // --- App Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const jobIdFromUrl = urlParams.get('jobId');

            const storedDescriptions = localStorage.getItem('chargeDescriptions');
            if (storedDescriptions) {
                chargeDescriptions = JSON.parse(storedDescriptions);
            } else {
                chargeDescriptions = [
                    'Ex-works Charges:', 'Land/Air / Sea Freight:', 'Fuell Security / War Surcharge:', 'Formalities:', 'Delivery Order Fee:', 'Transportation Charges:', 'Inspection / Computer Print Charges:', 'Handling Charges:', 'Labor / Forklift Charges:', 'Documentation Charges:', 'Clearance Charges:', 'Customs Duty:', 'Terminal Handling Charges:', 'Legalization Charges:', 'Demurrage Charges:', 'Loading / Offloading Charges:', 'Destination Clearance Charges:', 'Packing Charges:', 'Port Charges:', 'Other Charges:', 'PAI Approval :', 'Insurance Fee :', 'EPA Charges :'
                ];
                localStorage.setItem('chargeDescriptions', JSON.stringify(chargeDescriptions));
            }

            if (jobIdFromUrl) {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-container').style.display = 'none';
                showLoader();
                initializeFirebaseAndShowPublicView(jobIdFromUrl);
            } else {
                initializeFirebase();
            }
            
            let isLogin = true;

            document.getElementById('auth-link').addEventListener('click', (e) => {
                e.preventDefault();
                isLogin = !isLogin;
                toggleAuthView(isLogin);
            });

            document.getElementById('auth-btn').addEventListener('click', () => {
                const email = document.getElementById('email-address').value;
                const password = document.getElementById('password').value;
                if (isLogin) {
                    handleLogin(email, password);
                } else {
                    const displayName = document.getElementById('full-name').value;
                     if (!email || !password || !displayName) {
                         showNotification("Please fill all fields to sign up.", true);
                         return;
                    }
                    handleSignUp(email, password, displayName);
                }
            });
            
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            document.getElementById('approve-btn').addEventListener('click', () => approveJobFile());
            document.getElementById('reject-btn').addEventListener('click', () => promptForRejection(null));
            document.getElementById('confirm-reject-btn').addEventListener('click', rejectJobFile);
            document.getElementById('check-btn').addEventListener('click', () => checkJobFile());
            document.getElementById('admin-panel-btn').addEventListener('click', openAdminPanel);
            document.getElementById('forgot-password-link').addEventListener('click', (e) => {
                e.preventDefault();
                openModal('forgot-password-modal');
            });
            document.getElementById('send-reset-link-btn').addEventListener('click', handleForgotPassword);

            document.getElementById('activity-log-btn').addEventListener('click', openUserActivityLog);

            document.getElementById('search-bar').addEventListener('input', applyFiltersAndDisplay);
            document.getElementById('filter-status').addEventListener('change', applyFiltersAndDisplay);
            document.getElementById('filter-date-from').addEventListener('change', applyFiltersAndDisplay);
            document.getElementById('filter-date-to').addEventListener('change', applyFiltersAndDisplay);
            document.getElementById('clear-filters-btn').addEventListener('click', () => {
                document.getElementById('search-bar').value = '';
                document.getElementById('filter-status').value = '';
                document.getElementById('filter-date-from').value = '';
                document.getElementById('filter-date-to').value = '';
                applyFiltersAndDisplay();
            });

            document.getElementById('client-form').addEventListener('submit', saveClient);
            document.getElementById('clear-client-form-btn').addEventListener('click', clearClientForm);
            document.getElementById('client-search-bar').addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const filteredClients = clientsCache.filter(client => client.name.toLowerCase().includes(searchTerm));
                displayClients(filteredClients);
            });

            setupAutocomplete('shipper-name', 'shipper-suggestions', 'Shipper');
            setupAutocomplete('consignee-name', 'consignee-suggestions', 'Consignee');


            window.addEventListener('afterprint', () => {
                document.getElementById('main-container').style.display = 'block';
                document.getElementById('print-output').style.display = 'none';
            });
            
            window.openAnalyticsDashboard = openAnalyticsDashboard;
            window.closeAnalyticsDashboard = closeAnalyticsDashboard;
            window.openFileManager = () => openModal('file-manager-modal');
            window.openClientManager = openClientManager;
            window.saveJobFile = saveJobFile;
            window.clearForm = clearForm;
            window.printPage = printPage;
            window.closeModal = closeModal;
            window.saveUserChanges = saveUserChanges;
            window.sortAnalyticsTable = sortAnalyticsTable;
            window.downloadAnalyticsCsv = downloadAnalyticsCsv;
            window.previewJobFileById = previewJobFileById;
            window.loadJobFileById = loadJobFileById;
            window.confirmDelete = confirmDelete;
            window.editClient = editClient;
            window.printAnalytics = printAnalytics;
            window.printPreview = printPreview;
            window.generateRemarks = generateRemarks;
            window.suggestCharges = suggestCharges;
            window.backupAllData = backupAllData;
            window.handleRestoreFile = handleRestoreFile;
            window.showUserJobs = showUserJobs;
            window.showMonthlyJobs = showMonthlyJobs;
            window.showSalesmanJobs = showSalesmanJobs;
            window.showStatusJobs = showStatusJobs;
            window.checkJobFile = checkJobFile;
            window.approveJobFile = approveJobFile;
            window.uncheckJobFile = uncheckJobFile;
            window.openRecycleBin = openRecycleBin;
            window.restoreJobFile = restoreJobFile;
            window.confirmPermanentDelete = confirmPermanentDelete;
            window.filterAnalyticsByTimeframe = filterAnalyticsByTimeframe;
            window.promptForRejection = promptForRejection;
            window.displayAnalytics = displayAnalytics;
            window.openChargeManager = openChargeManager;
            window.saveChargeDescription = saveChargeDescription;
            window.deleteChargeDescription = deleteChargeDescription;
            window.addChargeRow = addChargeRow;

            populateTable();
            calculate();
            document.getElementById('date').valueAsDate = new Date();
        });
    </script>
</body>
</html>