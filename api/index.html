<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job File Management System with Database</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <style>
        :root { --theme-color: #4f46e5; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 1200px;
            margin: 1rem auto;
            padding: 1rem;
            background-color: white;
            border-radius: 0.75rem; /* Slightly larger radius */
            border-top: 5px solid var(--theme-color);
            box-shadow: 0 10px 25px rgba(0,0,0,0.05); /* Softer shadow */
        }
        @media (min-width: 640px) {
            .container {
                margin: 2rem auto;
                padding: 2.5rem; /* More padding on desktop */
            }
        }
        .input-field {
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
            width: 100%;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .input-field:focus {
            outline: none;
            border-color: var(--theme-color);
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.3); /* Improved focus ring */
        }
        .input-field:disabled {
            background-color: #f3f4f6;
            cursor: not-allowed;
            color: #6b7280;
        }
        .table-cell {
            border: 1px solid #e5e7eb; /* Lighter border */
            padding: 0.5rem;
            position: relative;
        }
        @media (min-width: 640px) {
            .table-cell {
                padding: 0.75rem;
            }
        }
        .table-cell input {
            width: 100%;
            border: none;
            padding: 0;
            background-color: transparent;
        }
        .table-cell input:focus {
            outline: none;
        }
        
        .overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.5); display: flex;
            align-items: center; justify-content: center; z-index: 1000;
            opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s;
            padding: 1rem;
        }
        .overlay.visible {
            opacity: 1; visibility: visible;
        }
        .modal-content {
            background: white; padding: 1.5rem; border-radius: 0.5rem;
            width: 100%;
            max-width: 600px;
            max-height: 90vh; overflow-y: auto;
            transform: scale(0.9); transition: transform 0.3s;
        }
        .overlay.visible .modal-content {
            transform: scale(1);
        }
        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid var(--theme-color);
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #notification {
            position: fixed; bottom: 20px; left: 50%;
            transform: translateX(-50%);
            background-color: #2d3748; color: white;
            padding: 1rem 1.5rem; border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translate(-50%, 100px); opacity: 0;
            transition: transform 0.5s, opacity 0.5s;
            z-index: 2000;
            text-align: center;
        }
        #notification.show {
            transform: translate(-50%, 0); opacity: 1;
        }

        @page { size: A4; margin: 0.5cm; }
        @media print {
            body { background-color: white !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            #main-container, .no-print, #app-container, #login-screen { display: none !important; }
            #print-output, #public-view-container, #analytics-container { display: block !important; padding: 0 !important; margin: 0 !important; }
        }
        #print-output .print-table, #preview-modal .print-table, #analytics-container .analytics-table { border-collapse: collapse; width: 100%; }
        #print-output .print-table th, #print-output .print-table td,
        #preview-modal .print-table th, #preview-modal .print-table td,
        #analytics-container .analytics-table th, #analytics-container .analytics-table td { border: 1px solid #d1d5db; padding: 0.5rem; text-align: left; }
        #analytics-container .analytics-table th { background-color: #f3f4f6; font-weight: 600; }
        #print-output .print-field, #preview-modal .print-field { border: 1px solid #6b7280; padding: 0.3rem; min-height: 24px; word-break: break-all; }
        .admin-only, .checker-only, #signup-name-field { display: none; }
        
        .stamp {
            position: absolute;
            top: -10px; right: -10px;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: bold;
            text-transform: uppercase;
            transform: rotate(15deg);
            opacity: 0.8;
            display: none;
        }
        .stamp-approved { border: 2px solid #16a34a; color: #16a34a; }
        .stamp-checked { border: 2px solid #2563eb; color: #2563eb; }
        .stamp-rejected { border: 2px solid #dc2626; color: #dc2626; }

        /* Autocomplete styles */
        .autocomplete-suggestions {
            border: 1px solid #d1d5db;
            border-top: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            max-height: 150px;
            overflow-y: auto;
            position: absolute;
            background-color: white;
            z-index: 999;
            width: 100%;
        }
        .autocomplete-suggestion {
            padding: 0.5rem;
            cursor: pointer;
        }
        .autocomplete-suggestion:hover {
            background-color: #f3f4f6;
        }
        .autocomplete-suggestion.selected {
            background-color: #e5e7eb;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
        <div class="max-w-md w-full space-y-8">
            <div>
                <img class="mx-auto h-24 w-auto" src="https://qgocargo.com/logo.png" alt="Q'go Cargo Logo">
                <h2 id="auth-title" class="mt-6 text-center text-3xl font-extrabold text-gray-900">Sign in to your account</h2>
            </div>
            <div class="mt-8 space-y-6 bg-white p-8 rounded-lg shadow-md">
                <div id="approval-message" class="hidden p-4 text-center text-yellow-800 bg-yellow-100 rounded-lg">
                    Your account is awaiting admin approval.
                </div>
                 <div id="blocked-message" class="hidden p-4 text-center text-red-800 bg-red-100 rounded-lg">
                    Your account has been blocked by an administrator.
                </div>
                <div class="rounded-md shadow-sm -space-y-px">
                    <div id="signup-name-field">
                        <label for="full-name" class="sr-only">Full Name</label>
                        <input id="full-name" name="name" type="text" autocomplete="name" required class="input-field rounded-t-md" placeholder="Full Name">
                    </div>
                    <div>
                        <label for="email-address" class="sr-only">Email address</label>
                        <input id="email-address" name="email" type="email" autocomplete="email" required class="input-field" placeholder="Email address">
                    </div>
                    <div>
                        <label for="password" class="sr-only">Password</label>
                        <input id="password" name="password" type="password" autocomplete="current-password" required class="input-field rounded-b-md" placeholder="Password">
                    </div>
                </div>
                <div>
                    <button id="auth-btn" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Sign in
                    </button>
                </div>
                <p class="mt-2 text-center text-sm text-gray-600">
                    <a href="#" id="auth-link" class="font-medium text-indigo-600 hover:text-indigo-500">
                        Create a new account
                    </a>
                </p>
                <div class="text-center mt-2 text-sm">
                    <a href="#" id="forgot-password-link" class="font-medium text-indigo-600 hover:text-indigo-500">
                        Forgot your password?
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Application Container (Hidden by default) -->
    <div id="app-container" class="hidden">
        <div id="main-container" class="container">
            <!-- Header Section -->
            <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                <div class="flex items-center">
                    <img id="logo-container" class="h-16 w-auto mr-4" src="https://qgocargo.com/logo.png" alt="Q'go Cargo Logo">
                    <h1 class="text-3xl sm:text-4xl font-bold text-gray-800 border-l-4 border-gray-300 pl-4">JOB FILE</h1>
                </div>
                <div class="text-right w-full sm:w-auto">
                    <div class="flex items-center mb-2">
                        <label for="date" class="mr-2 font-semibold text-gray-700">Date:</label>
                        <input type="date" id="date" class="input-field w-full sm:w-40">
                    </div>
                    <div class="flex items-center">
                        <label for="po-number" class="mr-2 font-semibold text-gray-700">P.O. #:</label>
                        <input type="text" id="po-number" class="input-field w-full sm:w-40">
                    </div>
                </div>
            </header>
            
            <!-- User Info and Logout -->
            <div class="flex flex-col sm:flex-row justify-between items-center mb-4 bg-gray-50 p-2 rounded-md gap-2">
                <div class="text-sm text-center sm:text-left">
                    Logged in as: <span id="user-display-name" class="font-bold"></span> (<span id="user-role" class="capitalize"></span>)
                </div>
                 <div class="flex-grow text-center">
                     <button onclick="openAnalyticsDashboard()" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-5 rounded-md text-base">Analytics</button>
                 </div>
                <div>
                    <button id="activity-log-btn" class="admin-only bg-gray-500 hover:bg-gray-600 text-white font-bold py-1 px-3 rounded text-sm mr-2">Activity Log</button>
                    <button id="admin-panel-btn" class="admin-only bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-1 px-3 rounded text-sm mr-2">Admin Panel</button>
                    <button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded text-sm">Logout</button>
                </div>
            </div>
            
            <!-- Status Summary -->
            <div id="status-summary-main" class="mb-4"></div>

            <div id="checker-info-banner" class="checker-only hidden p-3 mb-4 text-center text-blue-800 bg-blue-100 rounded-lg">
                <strong>Note:</strong> Files must be checked before they can be approved or rejected by an admin.
            </div>

            <div id="rejection-banner" class="hidden p-3 mb-4 text-center text-red-800 bg-red-100 rounded-lg">
                <strong>This job file was rejected.</strong> Reason: <span id="rejection-reason"></span>
            </div>

            <!-- Form Fields -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                <div class="lg:col-span-2">
                    <label for="job-file-no" class="block mb-1 font-semibold text-gray-700">Job File No.:</label>
                    <input type="text" id="job-file-no" class="input-field" placeholder="Enter a unique ID here...">
                </div>
                <div class="flex items-end space-x-8 pb-1">
                    <div>
                        <span class="font-semibold text-gray-700">Clearance</span>
                        <div class="mt-2 space-y-1">
                            <label class="flex items-center"><input type="checkbox" class="mr-2" data-clearance="Export"> Export</label>
                            <label class="flex items-center"><input type="checkbox" class="mr-2" data-clearance="Import"> Import</label>
                            <label class="flex items-center"><input type="checkbox" class="mr-2" data-clearance="Clearance"> Clearance</label>
                            <label class="flex items-center"><input type="checkbox" class="mr-2" data-clearance="Local Move"> Local Move</label>
                        </div>
                    </div>
                    <div>
                        <span class="font-semibold text-gray-700">Product Type</span>
                        <div class="mt-2 space-y-1">
                            <label class="flex items-center"><input type="checkbox" class="mr-2" data-product="Air Freight"> Air Freight</label>
                            <label class="flex items-center"><input type="checkbox" class="mr-2" data-product="Sea Freight"> Sea Freight</label>
                            <label class="flex items-center"><input type="checkbox" class="mr-2" data-product="Land Freight"> Land Freight</label>
                            <label class="flex items-center"><input type="checkbox" class="mr-2" data-product="Others"> Others</label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div><label for="invoice-no" class="block mb-1 font-semibold text-gray-700">Invoice No.:</label><input type="text" id="invoice-no" class="input-field"></div>
                <div><label for="billing-date" class="block mb-1 font-semibold text-gray-700">Billing Date:</label><input type="date" id="billing-date" class="input-field"></div>
                <div><label for="salesman" class="block mb-1 font-semibold text-gray-700">Salesman:</label><input type="text" id="salesman" class="input-field"></div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="relative">
                    <label for="shipper-name" class="block mb-1 font-semibold text-gray-700">Shipper's Name:</label>
                    <input type="text" id="shipper-name" class="input-field" autocomplete="off">
                    <div id="shipper-suggestions" class="autocomplete-suggestions hidden"></div>
                </div>
                <div class="relative">
                    <label for="consignee-name" class="block mb-1 font-semibold text-gray-700">Consignee's Name:</label>
                    <input type="text" id="consignee-name" class="input-field" autocomplete="off">
                    <div id="consignee-suggestions" class="autocomplete-suggestions hidden"></div>
                </div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                <div><label for="mawb" class="block mb-1 font-semibold text-gray-700">MAWB / OBL / TCN No.:</label><input type="text" id="mawb" class="input-field"></div>
                <div><label for="hawb" class="block mb-1 font-semibold text-gray-700">HAWB / HBL:</label><input type="text" id="hawb" class="input-field"></div>
                <div><label for="teams-of-shipping" class="block mb-1 font-semibold text-gray-700">Teams of Shipping:</label><input type="text" id="teams-of-shipping" class="input-field"></div>
                <div><label for="origin" class="block mb-1 font-semibold text-gray-700">Origin:</label><input type="text" id="origin" class="input-field"></div>
                <div><label for="no-of-pieces" class="block mb-1 font-semibold text-gray-700">No. of Pieces:</label><input type="text" id="no-of-pieces" class="input-field"></div>
                <div><label for="gross-weight" class="block mb-1 font-semibold text-gray-700">Gross Weight:</label><input type="text" id="gross-weight" class="input-field"></div>
                <div><label for="destination" class="block mb-1 font-semibold text-gray-700">Destination:</label><input type="text" id="destination" class="input-field"></div>
                <div><label for="volume-weight" class="block mb-1 font-semibold text-gray-700">Volume Weight:</label><input type="text" id="volume-weight" class="input-field"></div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="sm:col-span-2">
                    <label for="description" class="block mb-1 font-semibold text-gray-700">Description:</label>
                    <input type="text" id="description" class="input-field">
                </div>
                <div><label for="carrier" class="block mb-1 font-semibold text-gray-700">Carrier / Shipping Line / Trucking Co:</label><input type="text" id="carrier" class="input-field"></div>
                <div><label for="truck-no" class="block mb-1 font-semibold text-gray-700">Truck No. / Driver's Name:</label><input type="text" id="truck-no" class="input-field"></div>
                <div><label for="vessel-name" class="block mb-1 font-semibold text-gray-700">Vessel's Name:</label><input type="text" id="vessel-name" class="input-field"></div>
                <div><label for="flight-voyage-no" class="block mb-1 font-semibold text-gray-700">Flight / Voyage No.:</label><input type="text" id="flight-voyage-no" class="input-field"></div>
                <div><label for="container-no" class="block mb-1 font-semibold text-gray-700">Container No.:</label><input type="text" id="container-no" class="input-field"></div>
            </div>

            <!-- Charges Table -->
            <div class="flex justify-between items-center mb-2">
                 <h2 class="text-xl font-semibold text-gray-800">Charges</h2>
                 <div>
                     <button onclick="openChargeManager()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-1 px-3 rounded-lg text-sm transition-transform transform hover:scale-105 mr-2">Manage Descriptions</button>
                     <button onclick="suggestCharges()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-1 px-3 rounded-lg text-sm transition-transform transform hover:scale-105">Suggest Charges ✨</button>
                 </div>
            </div>
            <div class="mb-6 overflow-x-auto border border-gray-200 rounded-lg">
                <table id="charges-table" class="w-full border-collapse">
                    <!-- JS will populate this -->
                </table>
            </div>
            <div class="text-right mb-6">
                 <button onclick="addChargeRow()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg text-sm">+ Add Charge</button>
            </div>

            <!-- Remarks Section -->
            <div class="flex justify-between items-center mb-2">
                <label for="remarks" class="block font-semibold text-gray-700">REMARKS:</label>
                <button onclick="generateRemarks()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-1 px-3 rounded-lg text-sm transition-transform transform hover:scale-105">Generate Remarks ✨</button>
            </div>
            <div class="mb-8">
                <textarea id="remarks" rows="4" class="input-field w-full"></textarea>
            </div>

            <!-- Creator/Editor Info -->
            <div id="file-info" class="text-xs text-gray-500 mb-4 border-t pt-4">
                <span id="created-by-info"></span>
                <span id="last-updated-by-info" class="ml-4"></span>
            </div>

            <!-- Footer Section -->
            <footer class="grid grid-cols-1 md:grid-cols-3 gap-8 pt-6 border-t items-end">
                <div><label class="block mb-2 font-semibold text-gray-700">PREPARED BY</label><input type="text" id="prepared-by" class="input-field bg-gray-100" readonly></div>
                <div class="relative">
                    <div id="checked-stamp" class="stamp stamp-checked">Checked</div>
                    <label class="block mb-2 font-semibold text-gray-700">CHECKED BY</label>
                    <input type="text" id="checked-by" class="input-field bg-gray-100" readonly>
                    <button id="check-btn" class="checker-only mt-2 w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">Check Job File</button>
                </div>
                <div class="relative">
                    <div id="approved-stamp" class="stamp stamp-approved">Approved</div>
                    <div id="rejected-stamp" class="stamp stamp-rejected">Rejected</div>
                    <label class="block mb-2 font-semibold text-gray-700">APPROVED BY</label>
                    <input type="text" id="approved-by" class="input-field bg-gray-100" readonly>
                    <div id="approval-buttons" class="admin-only mt-2 w-full flex gap-2">
                        <button id="approve-btn" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded">Approve</button>
                        <button id="reject-btn" class="flex-1 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded">Reject</button>
                    </div>
                </div>
            </footer>

            <!-- Action Buttons -->
            <div class="text-center mt-10 no-print flex flex-wrap justify-center gap-2 sm:gap-4">
                 <button onclick="openClientManager()" class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-transform transform hover:scale-105 flex items-center space-x-2">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z" /></svg>
                     <span>Clients</span>
                 </button>
                 <button onclick="openFileManager()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-transform transform hover:scale-105 flex items-center space-x-2">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4l2 2h4a2 2 0 012 2v1H8a3 3 0 00-3 3v1.586l.293.293a1 1 0 001.414 0L10.414 12l-1.293 1.293a1 1 0 000 1.414l.293.293V16a2 2 0 01-2 2H4a2 2 0 01-2-2V6zm8 2a1 1 0 000-2H4a1 1 0 00-1 1v10a1 1 0 001 1h4a1 1 0 001-1v-1.586l-.293-.293a1 1 0 01-1.414 0L6.586 12l1.293-1.293a1 1 0 011.414 0l.293-.293V8z" clip-rule="evenodd" /><path d="M18 8a2 2 0 00-2-2h-4l-2-2h-4a2 2 0 00-2 2v.5a1 1 0 002 0V6a1 1 0 011-1h2.586l2 2H16a1 1 0 011 1v8a1 1 0 01-1 1h-2.5a1 1 0 100 2H16a2 2 0 002-2V8z" /></svg>
                     <span>File Manager</span>
                 </button>
                 <button onclick="saveJobFile()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-transform transform hover:scale-105 flex items-center space-x-2">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M7.707 10.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6a1 1 0 10-2 0v5.586L7.707 10.293zM3 4a1 1 0 011-1h12a1 1 0 011 1v4a1 1 0 01-1 1h-2a1 1 0 00-1 1v4a1 1 0 001 1h2a1 1 0 011 1v4a1 1 0 01-1 1H4a1 1 0 01-1-1v-4a1 1 0 011-1h2a1 1 0 001-1V9a1 1 0 00-1-1H4a1 1 0 01-1-1V4z" /></svg>
                     <span>Save to DB</span>
                 </button>
                 <button onclick="clearForm()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-transform transform hover:scale-105 flex items-center space-x-2">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.898 0V3a1 1 0 112 0v2.101a7.002 7.002 0 01-11.898 0V3a1 1 0 01-1-1zM12 10a2 2 0 11-4 0 2 2 0 014 0zM4 10a2 2 0 00-2 2v2a2 2 0 002 2h12a2 2 0 002-2v-2a2 2 0 00-2-2h-1.101A7.002 7.002 0 0010 12c-2.256 0-4.233-.996-5.5-2.543A7.002 7.002 0 004 10z" clip-rule="evenodd" /></svg>
                     <span>New Job</span>
                 </button>
                 <button onclick="printPage()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-transform transform hover:scale-105 flex items-center space-x-2">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v6a2 2 0 002 2h12a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v4h6v-4z" clip-rule="evenodd" /></svg>
                     <span>Print</span>
                 </button>
            </div>
        </div>
    </div>

    <!-- This container is hidden by default and will be populated for printing/preview -->
    <div id="print-output" class="hidden"></div>
    
    <!-- This container is for the public QR code view -->
    <div id="public-view-container"></div>

    <!-- Analytics Full-Screen Page -->
    <div id="analytics-container" class="hidden fixed inset-0 bg-gray-100 z-50 overflow-y-auto">
        <div class="container">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-2 no-print">
                <h3 class="text-2xl font-bold">Analytics Dashboard</h3>
                <div>
                    <button onclick="printAnalytics()" title="Print Analytics" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-3 rounded mr-4">🖨️ Print</button>
                    <button onclick="closeAnalyticsDashboard()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-3 rounded">Back to Job File</button>
                </div>
            </div>
            <div id="analytics-body" class="space-y-6"></div>
        </div>
    </div>


    <!-- Modals -->
    <div id="loader-overlay" class="overlay"><div class="loader"></div></div>
    <div id="notification"></div>
    
    <!-- File Manager Modal -->
    <div id="file-manager-modal" class="overlay">
        <div class="modal-content max-w-5xl"> <!-- Increased width for filters -->
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold">File Manager</h3>
                <div>
                    <button onclick="openRecycleBin()" class="admin-only bg-gray-600 hover:bg-gray-700 text-white font-bold py-1 px-3 rounded text-sm mr-4">Recycle Bin</button>
                    <button onclick="closeModal('file-manager-modal')" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
                </div>
            </div>
            
            <!-- Search and Filter Controls -->
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-4 p-4 bg-gray-50 rounded-lg">
                <div class="md:col-span-2">
                    <label for="search-bar" class="text-sm font-medium text-gray-700">Search</label>
                    <input type="text" id="search-bar" class="input-field mt-1" placeholder="Job No, Shipper, etc.">
                </div>
                <div>
                    <label for="filter-status" class="text-sm font-medium text-gray-700">Status</label>
                    <select id="filter-status" class="input-field mt-1">
                        <option value="">All Statuses</option>
                        <option value="pending">Pending</option>
                        <option value="checked">Checked</option>
                        <option value="approved">Approved</option>
                        <option value="rejected">Rejected</option>
                    </select>
                </div>
                <div>
                    <label for="filter-date-from" class="text-sm font-medium text-gray-700">From Date</label>
                    <input type="date" id="filter-date-from" class="input-field mt-1">
                </div>
                <div>
                    <label for="filter-date-to" class="text-sm font-medium text-gray-700">To Date</label>
                    <input type="date" id="filter-date-to" class="input-field mt-1">
                </div>
                <div class="flex items-end">
                    <button id="clear-filters-btn" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded text-sm">Clear Filters</button>
                </div>
            </div>

            <div id="job-files-list" class="space-y-2 max-h-[60vh] overflow-y-auto"></div>
        </div>
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="overlay">
        <div class="modal-content max-w-sm">
            <h3 class="text-lg font-bold mb-4" id="confirm-title">Confirm Action</h3>
            <div id="confirm-message" class="mb-4 text-sm">Are you sure?</div>
            <div class="text-right mt-6 space-x-2">
                <button id="confirm-cancel" class="bg-gray-300 hover:bg-gray-400 text-black font-bold py-2 px-4 rounded">Cancel</button>
                <button id="confirm-ok" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Preview Modal -->
    <div id="preview-modal" class="overlay">
        <div class="modal-content max-w-4xl">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-4 no-print gap-2">
                <h3 class="text-2xl font-bold">Job File Preview</h3>
                <div>
                    <button onclick="printPreview()" title="Print Preview" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-3 rounded mr-4">🖨️ Print</button>
                    <button onclick="closeModal('preview-modal')" class="text-gray-500 hover:text-gray-800 text-3xl align-middle">&times;</button>
                </div>
            </div>
            <div id="preview-body"></div>
        </div>
    </div>

    <!-- Admin Panel Modal -->
    <div id="admin-panel-modal" class="overlay">
        <div class="modal-content max-w-2xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold">Admin Panel</h3>
                <button onclick="closeModal('admin-panel-modal')" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>
        
            <!-- User Management -->
            <div class="border rounded-lg p-4">
                <h4 class="text-lg font-semibold mb-2">User Management</h4>
                <div id="user-list" class="space-y-2 max-h-[40vh] overflow-y-auto"></div>
                <div class="text-right mt-4">
                    <button onclick="saveUserChanges()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Save User Changes</button>
                </div>
            </div>
        
            <!-- Data Backup & Restore -->
            <div class="border rounded-lg p-4 mt-6">
                <h4 class="text-lg font-semibold mb-3">Data Migration</h4>
                <p class="text-sm text-gray-600 mb-4">Download all job files from the old Firebase database and convert them into a SQL file. You can then import this file into your new database using phpMyAdmin.</p>
                <div class="flex flex-col sm:flex-row gap-4">
                    <button onclick="backupAllData()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                        Generate Migration SQL File
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Rejection Reason Modal -->
    <div id="reject-reason-modal" class="overlay">
        <div class="modal-content max-w-md">
            <h3 class="text-lg font-bold mb-4">Rejection Reason</h3>
            <p class="mb-4">Please provide a reason for rejecting this job file.</p>
            <textarea id="rejection-reason-input" class="input-field w-full" rows="3"></textarea>
            <div class="text-right mt-6 space-x-2">
                <button onclick="closeModal('reject-reason-modal')" class="bg-gray-300 hover:bg-gray-400 text-black font-bold py-2 px-4 rounded">Cancel</button>
                <button id="confirm-reject-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">Confirm Rejection</button>
            </div>
        </div>
    </div>

    <!-- Forgot Password Modal -->
    <div id="forgot-password-modal" class="overlay">
        <div class="modal-content max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Reset Password</h3>
                <button onclick="closeModal('forgot-password-modal')" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>
            <p class="mb-4 text-gray-600">Enter your email address and we will send you a link to reset your password.</p>
            <div>
                <label for="reset-email" class="sr-only">Email address</label>
                <input id="reset-email" name="email" type="email" autocomplete="email" required class="input-field" placeholder="Email address">
            </div>
            <div class="text-right mt-6">
                <button id="send-reset-link-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded">
                    Send Password Reset Link
                </button>
            </div>
        </div>
    </div>

    <!-- Client Manager Modal -->
    <div id="client-manager-modal" class="overlay">
        <div class="modal-content max-w-4xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold">Client Management</h3>
                <button onclick="closeModal('client-manager-modal')" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Add/Edit Client Form -->
                <div>
                    <h4 id="client-form-title" class="text-xl font-semibold mb-4">Add New Client</h4>
                    <form id="client-form" class="space-y-4">
                        <input type="hidden" id="client-id">
                        <div>
                            <label for="client-name" class="block text-sm font-medium text-gray-700">Client Name</label>
                            <input type="text" id="client-name" class="input-field mt-1" required>
                        </div>
                        <div>
                            <label for="client-address" class="block text-sm font-medium text-gray-700">Address</label>
                            <textarea id="client-address" rows="2" class="input-field mt-1"></textarea>
                        </div>
                        <div>
                            <label for="client-contact-person" class="block text-sm font-medium text-gray-700">Contact Person</label>
                            <input type="text" id="client-contact-person" class="input-field mt-1">
                        </div>
                        <div>
                            <label for="client-phone" class="block text-sm font-medium text-gray-700">Phone</label>
                            <input type="text" id="client-phone" class="input-field mt-1">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Client Type</label>
                            <select id="client-type" class="input-field mt-1">
                                <option value="Shipper">Shipper</option>
                                <option value="Consignee">Consignee</option>
                                <option value="Both">Both</option>
                            </select>
                        </div>
                        <div class="flex gap-4">
                            <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Save Client</button>
                            <button type="button" id="clear-client-form-btn" class="w-full bg-gray-300 hover:bg-gray-400 text-black font-bold py-2 px-4 rounded">Clear</button>
                        </div>
                    </form>
                </div>
                <!-- Client List -->
                <div>
                    <h4 class="text-xl font-semibold mb-4">Existing Clients</h4>
                    <input type="text" id="client-search-bar" class="input-field mb-4" placeholder="Search clients...">
                    <div id="client-list" class="space-y-2 max-h-[50vh] overflow-y-auto">
                        <!-- Client list will be populated by JS -->
                    </div>
                </div>
            </div>
        </div>
    </div>

     <!-- Charge Manager Modal -->
    <div id="charge-manager-modal" class="overlay">
        <div class="modal-content max-w-lg">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold">Manage Charge Descriptions</h3>
                <button onclick="closeModal('charge-manager-modal')" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>
            <div class="space-y-4">
                <div>
                    <h4 class="text-lg font-semibold mb-2">Add New Description</h4>
                    <div class="flex gap-2">
                        <input type="text" id="new-charge-description" class="input-field" placeholder="E.g., Customs Duty">
                        <button onclick="saveChargeDescription()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Add</button>
                    </div>
                </div>
                <div>
                    <h4 class="text-lg font-semibold mb-2">Existing Descriptions</h4>
                    <div id="charge-description-list" class="space-y-2 max-h-[50vh] overflow-y-auto">
                        <!-- JS will populate this list -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Activity Log Modal -->
    <div id="activity-log-modal" class="overlay">
        <div class="modal-content max-w-4xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold">User Activity Log</h3>
                <button onclick="closeModal('activity-log-modal')" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>
            <div class="max-h-[70vh] overflow-y-auto">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="table-cell font-semibold text-left">User Name</th>
                            <th class="table-cell font-semibold text-left">Job File No.</th>
                            <th class="table-cell font-semibold text-left">Time Opened</th>
                        </tr>
                    </thead>
                    <tbody id="activity-log-body">
                        <!-- JS will populate this -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- User-Specific Jobs Modal -->
    <div id="user-jobs-modal" class="overlay">
        <div class="modal-content max-w-5xl">
            <div class="flex justify-between items-center mb-4">
                <h3 id="user-jobs-modal-title" class="text-2xl font-bold">User's Job Files</h3>
                <button onclick="closeModal('user-jobs-modal')" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>
            <div id="user-jobs-list" class="space-y-2 max-h-[70vh] overflow-y-auto">
                <!-- JS will populate this list -->
            </div>
        </div>
    </div>

    <!-- Recycle Bin Modal -->
    <div id="recycle-bin-modal" class="overlay">
        <div class="modal-content max-w-5xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold">Recycle Bin</h3>
                <button onclick="closeModal('recycle-bin-modal')" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>
            <div id="recycle-bin-list" class="space-y-2 max-h-[70vh] overflow-y-auto">
                <!-- JS will populate this list -->
            </div>
        </div>
    </div>


    <script>
        // --- Global variables ---
        let currentUser = null;
        let jobFilesCache = [];
        let clientsCache = [];
        let chargeDescriptions = [];
        let analyticsDataCache = null;
        let currentFilteredJobs = [];
        let fileIdToReject = null; 
        let profitChartInstance = null;
        let isLoginView = true;
        const API_BASE_URL = './';

        // --- API Helper ---
        async function fetchAPI(endpoint, options = {}) {
            try {
                const token = localStorage.getItem('authToken');
                const headers = {
                    'Content-Type': 'application/json',
                    ...options.headers,
                };
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }

                const response = await fetch(`${API_BASE_URL}${endpoint}`, { ...options, headers });

                if (response.status === 204) {
                    return null;
                }

                const responseData = await response.json().catch(() => {
                    return { message: response.statusText, status: response.status };
                });

                if (!response.ok) {
                     if (responseData.status === 500) {
                        throw new Error("Internal Server Error. Check server logs.");
                    }
                    throw new Error(responseData.message || 'An unknown API error occurred.');
                }
                return responseData;
            } catch (error) {
                console.error(`API Error on ${endpoint}:`, error);
                showNotification(error.message, true);
                throw error;
            }
        }


        // --- Authentication Logic ---
        async function handleSignUp(email, password, displayName) {
            showLoader();
            try {
                const data = await fetchAPI('auth.php?action=register', {
                    method: 'POST',
                    body: JSON.stringify({ email, password, displayName })
                });
                showNotification(data.message || "Account created! Please wait for admin approval.", false);
                toggleAuthView(true);
            } catch (e) {
                // error is shown by fetchAPI
            } finally {
                hideLoader();
            }
        }

        async function handleLogin(email, password) {
            showLoader();
            try {
                const data = await fetchAPI('auth.php?action=login', {
                    method: 'POST',
                    body: JSON.stringify({ email, password })
                });
                if (data.token && data.user) {
                    localStorage.setItem('authToken', data.token);
                    setCurrentUser(data.user);
                }
            } catch(e) {
                // error is shown by fetchAPI
            } finally {
                hideLoader();
            }
        }

        function setCurrentUser(user) {
             if (user.status === 'inactive') {
                showLogin();
                document.getElementById('approval-message').style.display = 'block';
                document.getElementById('blocked-message').style.display = 'none';
                handleLogout();
                return;
            }
            if (user.status === 'blocked') {
                showLogin();
                document.getElementById('approval-message').style.display = 'none';
                document.getElementById('blocked-message').style.display = 'block';
                handleLogout();
                return;
            }
            currentUser = user;
            showApp();
            showNotification("Login successful!", false);
            loadInitialData();
        }

        async function loadInitialData() {
            showLoader();
            try {
                await Promise.all([
                    loadJobFiles(),
                    loadClients()
                ]);
            } catch(e) {
                console.error("Failed to load initial data", e);
            } finally {
                hideLoader();
            }
        }
        
        async function handleForgotPassword() {
            showNotification("Forgot password functionality is not yet implemented.", true);
        }

        function handleLogout() {
            currentUser = null;
            localStorage.removeItem('authToken');
            jobFilesCache = [];
            clientsCache = [];
            showLogin();
        }

        async function checkToken() {
            const token = localStorage.getItem('authToken');
            if (token) {
                showLoader();
                try {
                    const data = await fetchAPI('auth.php?action=check_token');
                    if(data.user) {
                        setCurrentUser(data.user);
                    } else {
                        handleLogout();
                    }
                } catch(e) {
                    handleLogout();
                } finally {
                    hideLoader();
                }
            }
        }

        // --- Data Handling ---
        async function saveJobFile() {
            const jobFileNoInput = document.getElementById('job-file-no');
            let jobFileNo = jobFileNoInput.value.trim();
            if (!jobFileNo) { 
                showNotification("Please enter a Job File No.", true); 
                return; 
            }
            
            const isUpdating = jobFileNoInput.disabled;
            const data = getFormData();
            data.totalCost = parseFloat(document.getElementById('total-cost').textContent) || 0;
            data.totalSelling = parseFloat(document.getElementById('total-selling').textContent) || 0;
            data.totalProfit = parseFloat(document.getElementById('total-profit').textContent) || 0;

            showLoader();
            try {
                const endpoint = isUpdating ? `job-files.php?action=update&id=${encodeURIComponent(jobFileNo)}` : 'job-files.php?action=create';
                const method = isUpdating ? 'PUT' : 'POST';
                const result = await fetchAPI(endpoint, { method, body: JSON.stringify(data) });
                
                showNotification("Job file saved successfully!");
                await loadJobFiles(); // Refresh the list
                loadJobFileById(result.jobFile.jfn);
            } catch(e) {
                // error handled in fetchAPI
            } finally {
                hideLoader();
            }
        }
        
        async function checkJobFile(docId = null) {
            let fileId = docId || document.getElementById('job-file-no').value.trim();
            if(!fileId) {
                showNotification("No file to check.", true); return;
            }
             showLoader();
            try {
                const result = await fetchAPI(`job-files.php?action=check&id=${encodeURIComponent(fileId)}`, { method: 'POST' });
                if (!docId) {
                    populateFormFromData(result.jobFile);
                }
                await refreshOpenModals();
                showNotification("Job File Checked!");
            } catch(e) {
                 // error handled in fetchAPI
            } finally {
                hideLoader();
            }
        }

        async function approveJobFile(docId = null) {
            let fileId = docId || document.getElementById('job-file-no').value.trim();
            if(!fileId) {
                showNotification("No file to approve.", true); return;
            }
             showLoader();
            try {
                const result = await fetchAPI(`job-files.php?action=approve&id=${encodeURIComponent(fileId)}`, { method: 'POST' });
                if (!docId) {
                    populateFormFromData(result.jobFile);
                }
                await refreshOpenModals();
                showNotification("Job File Approved!");
            } catch(e) {
                // error handled in fetchAPI
            } finally {
                hideLoader();
            }
        }
        
        async function loadJobFiles() {
            try {
                const data = await fetchAPI('job-files.php?action=get_all');
                if (data && data.jobFiles) {
                    jobFilesCache = data.jobFiles.map(file => ({
                        ...file,
                        ch: JSON.parse(file.ch || '[]'),
                        cl: JSON.parse(file.cl || '[]'),
                        pt: JSON.parse(file.pt || '[]')
                    }));
                } else {
                    jobFilesCache = [];
                }
                updateStatusSummary('status-summary-main', jobFilesCache);
                // If file manager is open, refresh it.
                if (document.getElementById('file-manager-modal').classList.contains('visible')) {
                    displayJobFiles(jobFilesCache);
                }
            } catch(e) {
                jobFilesCache = [];
                updateStatusSummary('status-summary-main', []);
                displayJobFiles([]);
            }
        }
        
        async function refreshOpenModals() {
            if (document.getElementById('file-manager-modal').classList.contains('visible')) {
                await loadJobFiles();
                // Re-apply filters and search
                document.getElementById('search-bar').dispatchEvent(new Event('input'));
            }
            if (document.getElementById('analytics-container').style.display !== 'none') {
                 await openAnalyticsDashboard();
            }
        }


        async function loadJobFileById(docId) {
             showLoader();
            try {
                const data = await fetchAPI(`job-files.php?action=get&id=${encodeURIComponent(docId)}`);
                const file = {
                    ...data.jobFile,
                    ch: JSON.parse(data.jobFile.ch || '[]'),
                    cl: JSON.parse(data.jobFile.cl || '[]'),
                    pt: JSON.parse(data.jobFile.pt || '[]')
                };
                populateFormFromData(file);
                document.getElementById('job-file-no').disabled = true;
                closeAllModals();
                showNotification("Job file loaded successfully.");
            } catch(e) {
                // error handled in fetchAPI
            } finally {
                hideLoader();
            }
        }
        
        async function loadClients() {
            try {
                const data = await fetchAPI('clients.php?action=get_all');
                if (data && data.clients) {
                    clientsCache = data.clients;
                    clientsCache.sort((a, b) => a.name.localeCompare(b.name));
                } else {
                    clientsCache = [];
                }
                if(typeof displayClients === 'function') {
                    displayClients(clientsCache);
                }
            } catch(e) { /* error handled in fetchAPI */ }
        }
        
        // --- UI Functions ---
        function showLogin() {
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('app-container').style.display = 'none';
            document.getElementById('analytics-container').style.display = 'none';
        }

        function showApp() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-container').style.display = 'block';
            document.getElementById('analytics-container').style.display = 'none';
            document.getElementById('user-display-name').textContent = currentUser.displayName;
            document.getElementById('user-role').textContent = currentUser.role;

            document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.checker-only').forEach(el => el.style.display = 'none');
            
            if (currentUser.role === 'admin') {
                document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'block');
                document.querySelectorAll('.checker-only').forEach(el => el.style.display = 'block');
            } else if (currentUser.role === 'checker') {
                document.querySelectorAll('.checker-only').forEach(el => el.style.display = 'block');
            }
            
            clearForm();
        }

        function toggleAuthView(showLogin) {
            isLoginView = showLogin;
            const nameField = document.getElementById('signup-name-field');
            const emailField = document.getElementById('email-address');
            
            document.getElementById('auth-title').textContent = showLogin ? 'Sign in to your account' : 'Create a new account';
            document.getElementById('auth-btn').textContent = showLogin ? 'Sign in' : 'Sign up';
            document.getElementById('auth-link').textContent = showLogin ? 'Create a new account' : 'Already have an account? Sign in';
            nameField.style.display = showLogin ? 'none' : 'block';
            emailField.classList.toggle('rounded-t-md', !showLogin);
            document.getElementById('approval-message').style.display = 'none';
            document.getElementById('blocked-message').style.display = 'none';
        }
        
        function getFormData() {
            const getVal = id => document.getElementById(id).value || '';
            const getChecked = query => Array.from(document.querySelectorAll(query)).filter(el => el.checked).map(el => el.dataset.clearance || el.dataset.product);

            const charges = [];
            document.querySelectorAll('#charges-table-body tr:not(#total-row)').forEach(row => {
                const description = row.querySelector('.description-input').value.trim();
                const cost = row.querySelector('.cost-input').value;
                const selling = row.querySelector('.selling-input').value;

                if (description && (cost || selling)) {
                    charges.push({
                        l: description,
                        c: cost || '0',
                        s: selling || '0',
                        n: row.querySelector('.notes-input').value || ''
                    });
                }
            });

            return {
                d: getVal('date'), po: getVal('po-number'), jfn: getVal('job-file-no'),
                cl: getChecked('[data-clearance]:checked'), pt: getChecked('[data-product]:checked'),
                in: getVal('invoice-no'), bd: getVal('billing-date'), sm: getVal('salesman'),
                sh: getVal('shipper-name'), co: getVal('consignee-name'),
                mawb: getVal('mawb'), hawb: getVal('hawb'), ts: getVal('teams-of-shipping'), or: getVal('origin'),
                pc: getVal('no-of-pieces'), gw: getVal('gross-weight'), de: getVal('destination'), vw: getVal('volume-weight'),
                dsc: getVal('description'), ca: getVal('carrier'), tn: getVal('truck-no'),
                vn: getVal('vessel-name'), fv: getVal('flight-voyage-no'), cn: getVal('container-no'),
                ch: charges,
                re: getVal('remarks'),
                pb: getVal('prepared-by'),
            };
        }
        
        function populateFormFromData(data) {
            const setVal = (id, value) => { if (document.getElementById(id)) document.getElementById(id).value = value || ''; };
            const setChecked = (type, values) => {
                document.querySelectorAll(`[data-${type}]`).forEach(el => {
                    el.checked = (values || []).includes(el.dataset[type]);
                });
            };

            clearForm();
            
            setVal('date', data.d); setVal('po-number', data.po); setVal('job-file-no', data.jfn);
            setVal('invoice-no', data.in); setVal('billing-date', data.bd);
            setVal('salesman', data.sm); setVal('shipper-name', data.sh); setVal('consignee-name', data.co);
            setVal('mawb', data.mawb); setVal('hawb', data.hawb); setVal('teams-of-shipping', data.ts);
            setVal('origin', data.or); setVal('no-of-pieces', data.pc); setVal('gross-weight', data.gw);
            setVal('destination', data.de); setVal('volume-weight', data.vw); setVal('description', data.dsc);
            setVal('carrier', data.ca); setVal('truck-no', data.tn); setVal('vessel-name', data.vn);
            setVal('flight-voyage-no', data.fv); setVal('container-no', data.cn);
            setVal('remarks', data.re); 
            
            setVal('prepared-by', data.pb || data.createdBy || '');

            const createdInfo = document.getElementById('created-by-info');
            const updatedInfo = document.getElementById('last-updated-by-info');
            
            const toLocalDate = (dateString) => dateString ? new Date(dateString.replace(' ', 'T') + 'Z').toLocaleDateString() : '';
            const toLocalDateTime = (dateString) => dateString ? new Date(dateString.replace(' ', 'T') + 'Z').toLocaleString() : '';

            createdInfo.textContent = data.createdBy ? `Created by: ${data.createdBy} on ${toLocalDate(data.createdAt)}` : '';
            updatedInfo.textContent = data.lastUpdatedBy ? `Last updated by: ${data.lastUpdatedBy} on ${toLocalDateTime(data.updatedAt)}` : '';
            
            const checkBtn = document.getElementById('check-btn');
            if (data.checkedBy) {
                const checkedDate = data.checkedAt ? ` on ${toLocalDate(data.checkedAt)}` : '';
                setVal('checked-by', `${data.checkedBy}${checkedDate}`);
                checkBtn.disabled = true;
                checkBtn.textContent = 'Checked';
                document.getElementById('checked-stamp').style.display = 'block';
            }

            if (data.status === 'approved') {
                const approvedDate = data.approvedAt ? ` on ${toLocalDate(data.approvedAt)}` : '';
                setVal('approved-by', `${data.approvedBy}${approvedDate}`);
                document.getElementById('approved-stamp').style.display = 'block';
            } else if (data.status === 'rejected') {
                const rejectedDate = data.rejectedAt ? ` on ${toLocalDate(data.rejectedAt)}` : '';
                setVal('approved-by', `Rejected by ${data.rejectedBy}${rejectedDate}`);
                document.getElementById('rejected-stamp').style.display = 'block';
                document.getElementById('rejection-banner').style.display = 'block';
                document.getElementById('rejection-reason').textContent = data.rejectionReason;
            }

            setChecked('clearance', data.cl);
            setChecked('product', data.pt);

            const tableBody = document.getElementById('charges-table-body');
            tableBody.innerHTML = '';
            if (data.ch && data.ch.length > 0) {
                 data.ch.forEach(charge => addChargeRow(charge));
            } else {
               for(let i=0; i<5; i++) addChargeRow();
            }
            calculate();
        }

        function clearForm() {
            const form = document.querySelector('#main-container');
            form.querySelectorAll('input[type="text"], input[type="date"], textarea').forEach(input => input.value = '');
            form.querySelectorAll('input[type="checkbox"]').forEach(checkbox => checkbox.checked = false);
            
            document.getElementById('date').valueAsDate = new Date();
            document.getElementById('job-file-no').disabled = false;
            populateTable();
            calculate();
            
            if (currentUser) {
                document.getElementById('prepared-by').value = currentUser.displayName;
            }
            
            document.getElementById('created-by-info').textContent = '';
            document.getElementById('last-updated-by-info').textContent = '';

            document.getElementById('approved-by').value = '';
            document.getElementById('checked-by').value = '';
            document.getElementById('check-btn').disabled = false;
            document.getElementById('check-btn').textContent = 'Check Job File';
            
            document.getElementById('checked-stamp').style.display = 'none';
            document.getElementById('approved-stamp').style.display = 'none';
            document.getElementById('rejected-stamp').style.display = 'none';
            document.getElementById('rejection-banner').style.display = 'none';

            if(currentUser) {
                const isChecker = ['admin', 'checker'].includes(currentUser.role);
                const isAdmin = currentUser.role === 'admin';
                document.getElementById('check-btn').style.display = isChecker ? 'block' : 'none';
                document.getElementById('approval-buttons').style.display = isAdmin ? 'flex' : 'none';
            }

            showNotification("Form cleared. Ready for a new job file.");
        }
        
        function showLoader() { document.getElementById('loader-overlay').classList.add('visible'); }
        function hideLoader() { document.getElementById('loader-overlay').classList.remove('visible'); }

        function showNotification(message, isError = false) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.backgroundColor = isError ? '#c53030' : '#2d3748';
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        function populateTable() {
            const table = document.getElementById('charges-table');
            table.innerHTML = `
                <thead>
                    <tr class="bg-gray-100">
                        <th class="table-cell font-semibold w-2/5">Description</th>
                        <th class="table-cell font-semibold">Cost</th>
                        <th class="table-cell font-semibold">Selling</th>
                        <th class="table-cell font-semibold">Profit</th>
                        <th class="table-cell font-semibold">Notes</th>
                         <th class="table-cell font-semibold"></th>
                    </tr>
                </thead>
                <tbody id="charges-table-body">
                </tbody>
                <tfoot>
                     <tr id="total-row" class="bg-gray-100 font-bold">
                        <td class="table-cell text-right">TOTAL:</td>
                        <td id="total-cost" class="table-cell text-right">0.000</td>
                        <td id="total-selling" class="table-cell text-right">0.000</td>
                        <td id="total-profit" class="table-cell text-right">0.000</td>
                        <td class="table-cell" colspan="2"></td>
                    </tr>
                </tfoot>
            `;

            const tableBody = document.getElementById('charges-table-body');
            tableBody.addEventListener('input', e => {
                if (e.target.classList.contains('cost-input') || e.target.classList.contains('selling-input')) {
                    calculate();
                }
            });
             for(let i=0; i<5; i++) addChargeRow();
        }

        function addChargeRow(data = {}) {
            const tableBody = document.getElementById('charges-table-body');
            const newRow = document.createElement('tr');

            newRow.innerHTML = `
                <td class="table-cell"><input type="text" class="description-input input-field" value="${data.l || ''}" autocomplete="off"></td>
                <td class="table-cell"><input type="number" step="0.001" class="cost-input input-field" value="${data.c || ''}"></td>
                <td class="table-cell"><input type="number" step="0.001" class="selling-input input-field" value="${data.s || ''}"></td>
                <td class="table-cell profit-output bg-gray-50 text-right">${((data.s || 0) - (data.c || 0)).toFixed(3)}</td>
                <td class="table-cell"><input type="text" class="notes-input input-field" value="${data.n || ''}"></td>
                <td class="table-cell text-center"><button class="text-red-500 hover:text-red-700">&times;</button></td>
            `;

            const deleteButton = newRow.querySelector('button');
            deleteButton.addEventListener('click', () => {
                newRow.remove();
                calculate();
            });

            tableBody.appendChild(newRow);
        }

        function calculate() {
            let totalCost = 0, totalSelling = 0, totalProfit = 0;
            document.querySelectorAll('#charges-table-body tr:not(#total-row)').forEach(row => {
                const cost = parseFloat(row.querySelector('.cost-input').value) || 0;
                const selling = parseFloat(row.querySelector('.selling-input').value) || 0;
                const profit = selling - cost;
                row.cells[3].textContent = profit.toFixed(3);
                totalCost += cost; totalSelling += selling; totalProfit += profit;
            });
            document.getElementById('total-cost').textContent = totalCost.toFixed(3);
            document.getElementById('total-selling').textContent = totalSelling.toFixed(3);
            document.getElementById('total-profit').textContent = totalProfit.toFixed(3);
        }
        
        function openModal(id) { document.getElementById(id).classList.add('visible'); }
        function closeModal(id) { document.getElementById(id).classList.remove('visible'); }
        function closeAllModals() {
            document.querySelectorAll('.overlay').forEach(modal => modal.classList.remove('visible'));
        }

        function displayJobFiles(files) {
            currentFilteredJobs = files;
            const list = document.getElementById('job-files-list');
            if(!list) return;
            list.innerHTML = '';
            if (files.length === 0) {
                list.innerHTML = `<p class="text-center text-gray-500">No job files found.</p>`;
                return;
            }
            files.forEach(file => {
                const profit = (file.totalProfit || 0);
                const profitColor = profit >= 0 ? 'text-green-600' : 'text-red-600';
                const statusColors = {
                    pending: 'bg-gray-200 text-gray-800',
                    checked: 'bg-blue-200 text-blue-800',
                    approved: 'bg-green-200 text-green-800',
                    rejected: 'bg-red-200 text-red-800'
                };
                const statusClass = statusColors[file.status] || statusColors.pending;

                const fileDiv = document.createElement('div');
                fileDiv.className = 'p-3 border rounded-lg hover:bg-gray-50 grid grid-cols-12 gap-2 items-center';
                fileDiv.innerHTML = `
                    <div class="col-span-12 md:col-span-3">
                        <p class="font-bold text-gray-800">${file.jfn}</p>
                        <p class="text-sm text-gray-600">${file.sh || 'No Shipper'}</p>
                    </div>
                    <div class="col-span-4 md:col-span-2 text-sm">
                        <p class="text-gray-500">Date</p>
                        <p class="font-medium">${file.d || 'N/A'}</p>
                    </div>
                    <div class="col-span-4 md:col-span-2 text-sm">
                        <p class="text-gray-500">Salesman</p>
                        <p class="font-medium">${file.sm || 'N/A'}</p>
                    </div>
                    <div class="col-span-4 md:col-span-1 text-sm">
                         <p class="text-gray-500">Profit</p>
                         <p class="font-bold ${profitColor}">${profit.toFixed(3)}</p>
                    </div>
                    <div class="col-span-4 md:col-span-1 text-sm text-center">
                        <span class="px-2 py-1 text-xs font-semibold rounded-full ${statusClass}">${file.status}</span>
                    </div>
                    <div class="col-span-12 md:col-span-3 flex justify-end items-center gap-2">
                        <button onclick="loadJobFileById('${file.jfn}')" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-1 px-3 rounded text-sm">Open</button>
                    </div>
                `;
                list.appendChild(fileDiv);
            });
        }
        function updateStatusSummary(elementId, files) {
            const container = document.getElementById(elementId);
            if(!container) return;

            const counts = files.reduce((acc, file) => {
                const status = file.status || 'pending';
                acc[status] = (acc[status] || 0) + 1;
                return acc;
            }, { pending: 0, checked: 0, approved: 0, rejected: 0 });

            container.innerHTML = `
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 text-center text-sm">
                    <div class="p-2 bg-gray-200 rounded"><strong>Pending:</strong> ${counts.pending || 0}</div>
                    <div class="p-2 bg-blue-200 rounded"><strong>Checked:</strong> ${counts.checked || 0}</div>
                    <div class="p-2 bg-green-200 rounded"><strong>Approved:</strong> ${counts.approved || 0}</div>
                    <div class="p-2 bg-red-200 rounded"><strong>Rejected:</strong> ${counts.rejected || 0}</div>
                </div>
            `;
        }

        async function openFileManager() {
            openModal('file-manager-modal');
            await loadJobFiles();
            displayJobFiles(jobFilesCache);
        }

        // --- Analytics ---
        async function openAnalyticsDashboard() {
            showLoader();
            try {
                analyticsDataCache = await fetchAPI('analytics.php');
                renderAnalytics(analyticsDataCache);
                document.getElementById('analytics-container').style.display = 'block';
            } catch (e) {
                showNotification("Could not load analytics data.", true);
            } finally {
                hideLoader();
            }
        }

        function renderAnalytics(data) {
            const body = document.getElementById('analytics-body');
            body.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="bg-white p-4 rounded-lg shadow">
                        <h4 class="font-semibold text-gray-500">Total Jobs</h4>
                        <p class="text-3xl font-bold">${data.summary.totalJobs}</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow">
                        <h4 class="font-semibold text-gray-500">Total Profit</h4>
                        <p class="text-3xl font-bold text-green-600">${parseFloat(data.summary.totalProfit).toLocaleString('en-US', {minimumFractionDigits: 3})}</p>
                    </div>
                     <div class="bg-white p-4 rounded-lg shadow">
                        <h4 class="font-semibold text-gray-500">Total Cost</h4>
                        <p class="text-3xl font-bold text-red-600">${parseFloat(data.summary.totalCost).toLocaleString('en-US', {minimumFractionDigits: 3})}</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow">
                        <h4 class="font-semibold text-gray-500">Total Selling</h4>
                        <p class="text-3xl font-bold text-blue-600">${parseFloat(data.summary.totalSelling).toLocaleString('en-US', {minimumFractionDigits: 3})}</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-4 rounded-lg shadow">
                        <h4 class="text-lg font-bold mb-4">Monthly Profit</h4>
                        <canvas id="profit-chart"></canvas>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow">
                        <h4 class="text-lg font-bold mb-4">Jobs by Salesman</h4>
                        <div id="salesman-table-container"></div>
                    </div>
                </div>
            `;

            // Render Chart
            const ctx = document.getElementById('profit-chart').getContext('2d');
            if (profitChartInstance) {
                profitChartInstance.destroy();
            }
            profitChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.monthlyProfit.map(d => d.month),
                    datasets: [{
                        label: 'Total Profit',
                        data: data.monthlyProfit.map(d => d.totalProfit),
                        borderColor: 'rgba(75, 192, 192, 1)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        fill: true,
                        tension: 0.1
                    }]
                }
            });

            // Render Table
            const tableContainer = document.getElementById('salesman-table-container');
            let tableHTML = `<table class="w-full analytics-table"><thead><tr><th>Salesman</th><th>Job Count</th><th>Total Profit</th></tr></thead><tbody>`;
            data.salesmanPerformance.forEach(s => {
                tableHTML += `<tr><td>${s.salesman}</td><td>${s.jobCount}</td><td>${parseFloat(s.totalProfit).toFixed(3)}</td></tr>`;
            });
            tableHTML += `</tbody></table>`;
            tableContainer.innerHTML = tableHTML;
        }

        function closeAnalyticsDashboard() {
            document.getElementById('analytics-container').style.display = 'none';
        }
        function printAnalytics() {
            window.print();
        }

        // --- Data Migration (Firebase to SQL) ---
        async function backupAllData() {
            showLoader();
            try {
                const firebaseConfig = {
                    apiKey: prompt("Enter Firebase API Key"),
                    authDomain: prompt("Enter Firebase Auth Domain"),
                    projectId: prompt("Enter Firebase Project ID"),
                };

                if (!firebaseConfig.apiKey || !firebaseConfig.projectId) {
                    showNotification("Firebase config is required for migration.", true);
                    return;
                }

                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                const db = firebase.firestore();
                const jobFilesSnapshot = await db.collection("jobFiles").get();
                const jobFiles = jobFilesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                let sqlContent = "START TRANSACTION;\n\n";
                sqlContent += "DELETE FROM `job_files`;\n\n";

                const escapeSQL = (val) => {
                    if (val === null || val === undefined) return 'NULL';
                    val = val.toString().replace(/'/g, "''");
                    return `'${val}'`;
                };

                for (const file of jobFiles) {
                    // Sanitize and prepare data
                    const values = {
                        jfn: escapeSQL(file.id),
                        d: escapeSQL(file.d),
                        po: escapeSQL(file.po),
                        cl: escapeSQL(JSON.stringify(file.cl || [])),
                        pt: escapeSQL(JSON.stringify(file.pt || [])),
                        'in': escapeSQL(file.in), // 'in' is a keyword
                        bd: escapeSQL(file.bd),
                        sm: escapeSQL(file.sm),
                        sh: escapeSQL(file.sh),
                        co: escapeSQL(file.co),
                        mawb: escapeSQL(file.mawb),
                        hawb: escapeSQL(file.hawb),
                        ts: escapeSQL(file.ts),
                        'or': escapeSQL(file.or),
                        pc: escapeSQL(file.pc),
                        gw: escapeSQL(file.gw),
                        de: escapeSQL(file.de),
                        vw: escapeSQL(file.vw),
                        dsc: escapeSQL(file.dsc),
                        ca: escapeSQL(file.ca),
                        tn: escapeSQL(file.tn),
                        vn: escapeSQL(file.vn),
                        fv: escapeSQL(file.fv),
                        cn: escapeSQL(file.cn),
                        ch: escapeSQL(JSON.stringify(file.ch || [])),
                        re: escapeSQL(file.re),
                        pb: escapeSQL(file.pb),
                        status: escapeSQL(file.status || 'pending'),
                        createdBy: escapeSQL(file.createdBy),
                        createdAt: file.createdAt ? escapeSQL(new Date(file.createdAt.seconds * 1000).toISOString().slice(0, 19).replace('T', ' ')) : 'NULL',
                        lastUpdatedBy: escapeSQL(file.lastUpdatedBy),
                        updatedAt: file.updatedAt ? escapeSQL(new Date(file.updatedAt.seconds * 1000).toISOString().slice(0, 19).replace('T', ' ')) : 'NOW()',
                        checkedBy: escapeSQL(file.checkedBy),
                        checkedAt: file.checkedAt ? escapeSQL(new Date(file.checkedAt.seconds * 1000).toISOString().slice(0, 19).replace('T', ' ')) : 'NULL',
                        approvedBy: escapeSQL(file.approvedBy),
                        approvedAt: file.approvedAt ? escapeSQL(new Date(file.approvedAt.seconds * 1000).toISOString().slice(0, 19).replace('T', ' ')) : 'NULL',
                        rejectedBy: escapeSQL(file.rejectedBy),
                        rejectedAt: file.rejectedAt ? escapeSQL(new Date(file.rejectedAt.seconds * 1000).toISOString().slice(0, 19).replace('T', ' ')) : 'NULL',
                        rejectionReason: escapeSQL(file.rejectionReason),
                        totalCost: parseFloat(file.totalCost) || 0,
                        totalSelling: parseFloat(file.totalSelling) || 0,
                        totalProfit: parseFloat(file.totalProfit) || 0,
                        is_deleted: 0
                    };

                    const columns = Object.keys(values).map(c => `\`${c}\``).join(', ');
                    const rowValues = Object.values(values).join(', ');
                    sqlContent += `INSERT INTO \`job_files\` (${columns}) VALUES (${rowValues});\n`;
                }

                sqlContent += "\nCOMMIT;";
                
                const blob = new Blob([sqlContent], { type: 'application/sql' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'migration.sql';
                link.click();

                showNotification('SQL migration file generated successfully!', false);
            } catch (err) {
                console.error("Migration failed:", err);
                showNotification(`Migration failed: ${err.message}`, true);
            } finally {
                hideLoader();
            }
        }


        // --- App Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            
            checkToken();

            document.getElementById('auth-link').addEventListener('click', (e) => {
                e.preventDefault();
                toggleAuthView(!isLoginView);
            });

            document.getElementById('auth-btn').addEventListener('click', () => {
                const email = document.getElementById('email-address').value;
                const password = document.getElementById('password').value;
                if (isLoginView) {
                    handleLogin(email, password);
                } else {
                    const displayName = document.getElementById('full-name').value;
                     if (!email || !password || !displayName) {
                         showNotification("Please fill all fields to sign up.", true);
                         return;
                    }
                    handleSignUp(email, password, displayName);
                }
            });

            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            document.getElementById('admin-panel-btn').addEventListener('click', () => openModal('admin-panel-modal'));
            
            // Search and filter for file manager
            document.getElementById('search-bar').addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const filtered = jobFilesCache.filter(file => 
                    Object.values(file).some(val => val && val.toString().toLowerCase().includes(searchTerm))
                );
                displayJobFiles(filtered);
            });


            window.openAnalyticsDashboard = openAnalyticsDashboard;
            window.closeAnalyticsDashboard = closeAnalyticsDashboard;
            window.printAnalytics = printAnalytics;
            window.openFileManager = openFileManager;
            window.openClientManager = () => openModal('client-manager-modal');
            window.saveJobFile = saveJobFile;
            window.clearForm = clearForm;
            window.printPage = () => window.print();
            window.closeModal = closeModal;
            window.saveUserChanges = () => showNotification("Not implemented yet.", true);
            window.generateRemarks = () => showNotification("AI features not implemented yet.", true);
            window.suggestCharges = () => showNotification("AI features not implemented yet.", true);
            window.backupAllData = backupAllData;
            window.addChargeRow = addChargeRow;
            window.loadJobFileById = loadJobFileById;
        });

    </script>
</body>
</html>
