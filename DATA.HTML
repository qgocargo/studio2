<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIGRATION TOOL - Job File Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --theme-color: #4f46e5; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 1200px;
            margin: 1rem auto;
            padding: 1rem;
            background-color: white;
            border-radius: 0.75rem; 
            border-top: 5px solid var(--theme-color);
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
        }
        .input-field {
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
            width: 100%;
        }
        .overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.5); display: flex;
            align-items: center; justify-content: center; z-index: 1000;
            opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s;
        }
        .overlay.visible { opacity: 1; visibility: visible; }
        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid var(--theme-color);
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #notification {
            position: fixed; bottom: 20px; left: 50%;
            transform: translateX(-50%);
            background-color: #2d3748; color: white;
            padding: 1rem 1.5rem; border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translate(-50%, 100px); opacity: 0;
            transition: transform 0.5s, opacity 0.5s;
            z-index: 2000;
        }
        #notification.show { transform: translate(-50%, 0); opacity: 1; }
    </style>
</head>
<body class="bg-gray-100">
    <div id="loader-overlay" class="overlay"><div class="loader"></div></div>
    <div id="notification"></div>
    <div class="container text-center">
        <img class="mx-auto h-24 w-auto" src="https://qgocargo.com/logo.png" alt="Q'go Cargo Logo">
        <h1 class="text-2xl font-bold mt-4">One-Time Data Migration Tool</h1>
        <p class="text-gray-600 mt-2">Use this page ONLY to migrate your old data from Firebase to your new SQL database.</p>
        
        <div id="login-view" class="mt-8 max-w-sm mx-auto">
             <h2 class="text-xl font-semibold">Step 1: Login to Firebase</h2>
             <div class="mt-4 space-y-4 bg-white p-6 rounded-lg shadow-inner">
                <input id="email-address" type="email" class="input-field" placeholder="Enter your Firebase email">
                <input id="password" type="password" class="input-field" placeholder="Enter your Firebase password">
                <button id="login-btn" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded hover:bg-indigo-700">Login to Firebase</button>
             </div>
        </div>

        <div id="migration-view" class="hidden mt-8">
            <p class="text-lg">Logged in as: <strong id="user-display-name"></strong></p>
            <h2 class="text-xl font-semibold mt-6">Step 2: Generate and Download SQL File</h2>
            <p class="text-gray-600 mt-2">This will download all your existing job files from Firebase and convert them into a single `migration.sql` file. You can then import this file into your new database using phpMyAdmin.</p>
            <button id="migrate-btn" class="mt-4 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg">
                Generate and Download Migration SQL File
            </button>
            <p class="text-sm mt-4 text-gray-500">After downloading, you can close this page. Your live app is at your domain.</p>
        </div>
    </div>

    <!-- Firebase SDK and App Logic -->
    <script type="module">
        // Import Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        let db, auth;

        const firebaseConfig = {
            apiKey: "AIzaSyAAulR2nJQm-4QtNyEqKTnnDPw-iKW92Mc",
            authDomain: "my-job-file-system.firebaseapp.com",
            projectId: "my-job-file-system",
            storageBucket: "my-job-file-system.appspot.com",
            messagingSenderId: "145307873304",
            appId: "1:145307873304:web:d661ea6ec118801b4a136d",
            measurementId: "G-8EHX5K7YHL"
        };
        
        function showLoader() { document.getElementById('loader-overlay').classList.add('visible'); }
        function hideLoader() { document.getElementById('loader-overlay').classList.remove('visible'); }
        function showNotification(message, isError = false) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.backgroundColor = isError ? '#c53030' : '#2d3748';
            notification.classList.add('show');
            setTimeout(() => notification.classList.remove('show'), 3000);
        }

        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                 document.getElementById('login-btn').addEventListener('click', async () => {
                    const email = document.getElementById('email-address').value;
                    const password = document.getElementById('password').value;
                    if (!email || !password) {
                        showNotification("Please enter email and password.", true);
                        return;
                    }
                    showLoader();
                    try {
                        await signInWithEmailAndPassword(auth, email, password);
                    } catch (error) {
                        showNotification("Firebase login failed: " + error.message, true);
                    } finally {
                        hideLoader();
                    }
                });

                onAuthStateChanged(auth, (user) => {
                    if(user) {
                        document.getElementById('login-view').style.display = 'none';
                        document.getElementById('migration-view').style.display = 'block';
                        document.getElementById('user-display-name').textContent = user.displayName || user.email;
                    }
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showNotification("Could not connect to Firebase.", true);
            }
        }

        async function generateMigrationSql() {
            if (!db) {
                showNotification("Firestore is not initialized.", true);
                return;
            }
            showLoader();
            try {
                const jobFilesQuery = collection(db, 'jobfiles');
                const jobFilesSnapshot = await getDocs(jobFilesQuery);
                const jobFiles = jobFilesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                if (jobFiles.length === 0) {
                    showNotification("No job files found in Firebase to migrate.", false);
                    return;
                }

                let sqlContent = "START TRANSACTION;\n\n";
                sqlContent += "-- This will replace all job files in your new database.\n";
                sqlContent += "TRUNCATE TABLE `job_files`;\n\n";

                const escapeSQL = (val) => {
                    if (val === null || val === undefined) return 'NULL';
                    if (typeof val === 'boolean') return val ? '1' : '0';
                    if (typeof val === 'number') return val;
                    val = val.toString().replace(/'/g, "''").replace(/\\/g, '\\\\');
                    return `'${val}'`;
                };
                
                const formatDate = (timestamp) => {
                    if (!timestamp || typeof timestamp.toDate !== 'function') return 'NULL';
                    return escapeSQL(timestamp.toDate().toISOString().slice(0, 19).replace('T', ' '));
                };

                for (const file of jobFiles) {
                    const values = {
                        jfn: escapeSQL(file.jfn || file.id.replace(/_/g, '/')), // Use JFN, fallback to ID
                        d: file.d ? escapeSQL(file.d) : 'NULL',
                        po: escapeSQL(file.po),
                        cl: escapeSQL(JSON.stringify(file.cl || [])),
                        pt: escapeSQL(JSON.stringify(file.pt || [])),
                        'in': escapeSQL(file.in),
                        bd: file.bd ? escapeSQL(file.bd) : 'NULL',
                        sm: escapeSQL(file.sm),
                        sh: escapeSQL(file.sh),
                        co: escapeSQL(file.co),
                        mawb: escapeSQL(file.mawb),
                        hawb: escapeSQL(file.hawb),
                        ts: escapeSQL(file.ts),
                        'or': escapeSQL(file.or),
                        pc: escapeSQL(file.pc),
                        gw: escapeSQL(file.gw),
                        de: escapeSQL(file.de),
                        vw: escapeSQL(file.vw),
                        dsc: escapeSQL(file.dsc),
                        ca: escapeSQL(file.ca),
                        tn: escapeSQL(file.tn),
                        vn: escapeSQL(file.vn),
                        fv: escapeSQL(file.fv),
                        cn: escapeSQL(file.cn),
                        ch: escapeSQL(JSON.stringify(file.ch || [])),
                        re: escapeSQL(file.re),
                        pb: escapeSQL(file.pb || file.createdBy),
                        status: escapeSQL(file.status || 'pending'),
                        createdBy: escapeSQL(file.createdBy),
                        createdAt: formatDate(file.createdAt),
                        lastUpdatedBy: escapeSQL(file.lastUpdatedBy),
                        updatedAt: formatDate(file.updatedAt),
                        checkedBy: escapeSQL(file.checkedBy),
                        checkedAt: formatDate(file.checkedAt),
                        approvedBy: escapeSQL(file.approvedBy),
                        approvedAt: formatDate(file.approvedAt),
                        rejectedBy: escapeSQL(file.rejectedBy),
                        rejectedAt: formatDate(file.rejectedAt),
                        rejectionReason: escapeSQL(file.rejectionReason),
                        totalCost: parseFloat(file.totalCost) || 0,
                        totalSelling: parseFloat(file.totalSelling) || 0,
                        totalProfit: parseFloat(file.totalProfit) || 0,
                        is_deleted: 0
                    };

                    const columns = Object.keys(values).map(c => `\`${c}\``).join(', ');
                    const rowValues = Object.values(values).join(', ');
                    sqlContent += `INSERT INTO \`job_files\` (${columns}) VALUES (${rowValues});\n`;
                }

                sqlContent += "\nCOMMIT;";
                
                const blob = new Blob([sqlContent], { type: 'application/sql' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'migration.sql';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(link.href);

                showNotification(`Migration file with ${jobFiles.length} records generated successfully!`, false);

            } catch (err) {
                console.error("Migration failed:", err);
                showNotification(`Migration failed: ${err.message}`, true);
            } finally {
                hideLoader();
            }
        }
        
        document.getElementById('migrate-btn').addEventListener('click', generateMigrationSql);
        initializeFirebase();

    </script>
</body>
</html>

    